<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.34">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Owen Goodwin">

<title>Creating Cutting-Edge Geodemographic Classifications from Scratch in Python – Geographic Data Service Tutorials</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-9582434199d49cc9e91654cdeeb4866b.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-31fd3b4bc850d89516b0871d33aaa63f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../style.css">
</head>

<body class="floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Geographic Data Service Tutorials</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#workshop-content" id="toc-workshop-content" class="nav-link active" data-scroll-target="#workshop-content">Workshop Content</a></li>
  <li><a href="#what-are-geodemographics" id="toc-what-are-geodemographics" class="nav-link" data-scroll-target="#what-are-geodemographics">What are Geodemographics?</a>
  <ul class="collapse">
  <li><a href="#running-the-notebook-yourself" id="toc-running-the-notebook-yourself" class="nav-link" data-scroll-target="#running-the-notebook-yourself">Running the Notebook yourself</a></li>
  <li><a href="#install-required-packages-in-colab" id="toc-install-required-packages-in-colab" class="nav-link" data-scroll-target="#install-required-packages-in-colab">Install Required Packages in Colab</a></li>
  </ul></li>
  <li><a href="#retrieving-and-preparing-data" id="toc-retrieving-and-preparing-data" class="nav-link" data-scroll-target="#retrieving-and-preparing-data">Retrieving and Preparing Data</a>
  <ul class="collapse">
  <li><a href="#output-areas" id="toc-output-areas" class="nav-link" data-scroll-target="#output-areas">Output Areas</a></li>
  <li><a href="#spatial-standardisation" id="toc-spatial-standardisation" class="nav-link" data-scroll-target="#spatial-standardisation">Spatial Standardisation</a></li>
  <li><a href="#examine-the-data" id="toc-examine-the-data" class="nav-link" data-scroll-target="#examine-the-data">Examine the Data</a></li>
  <li><a href="#spatial-data" id="toc-spatial-data" class="nav-link" data-scroll-target="#spatial-data">Spatial Data</a>
  <ul class="collapse">
  <li><a href="#selecting-a-region" id="toc-selecting-a-region" class="nav-link" data-scroll-target="#selecting-a-region">Selecting a Region</a></li>
  <li><a href="#map-the-area" id="toc-map-the-area" class="nav-link" data-scroll-target="#map-the-area">Map the Area</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#transform-and-standardise-variables" id="toc-transform-and-standardise-variables" class="nav-link" data-scroll-target="#transform-and-standardise-variables">Transform and Standardise Variables</a>
  <ul class="collapse">
  <li><a href="#mathematical-definitions" id="toc-mathematical-definitions" class="nav-link" data-scroll-target="#mathematical-definitions">Mathematical definitions</a></li>
  </ul></li>
  <li><a href="#variable-selection" id="toc-variable-selection" class="nav-link" data-scroll-target="#variable-selection">Variable Selection</a>
  <ul class="collapse">
  <li><a href="#correlation-variance-analysis" id="toc-correlation-variance-analysis" class="nav-link" data-scroll-target="#correlation-variance-analysis">Correlation &amp; Variance Analysis</a></li>
  <li><a href="#selecting-variables" id="toc-selecting-variables" class="nav-link" data-scroll-target="#selecting-variables">Selecting Variables</a></li>
  </ul></li>
  <li><a href="#k-means-clustering" id="toc-k-means-clustering" class="nav-link" data-scroll-target="#k-means-clustering">K-Means Clustering</a>
  <ul class="collapse">
  <li><a href="#choosing-the-number-of-clusters-k---clustergrams" id="toc-choosing-the-number-of-clusters-k---clustergrams" class="nav-link" data-scroll-target="#choosing-the-number-of-clusters-k---clustergrams">Choosing the Number of Clusters (k) - Clustergrams</a></li>
  <li><a href="#apply-k-means-clustering" id="toc-apply-k-means-clustering" class="nav-link" data-scroll-target="#apply-k-means-clustering">Apply K-Means Clustering</a></li>
  <li><a href="#mapping-the-clusters" id="toc-mapping-the-clusters" class="nav-link" data-scroll-target="#mapping-the-clusters">Mapping the Clusters</a></li>
  <li><a href="#umap-visualisation" id="toc-umap-visualisation" class="nav-link" data-scroll-target="#umap-visualisation">UMAP Visualisation</a></li>
  </ul></li>
  <li><a href="#cluster-profiling-naming-and-describing-using-language-models" id="toc-cluster-profiling-naming-and-describing-using-language-models" class="nav-link" data-scroll-target="#cluster-profiling-naming-and-describing-using-language-models">Cluster Profiling, Naming, and Describing using Language Models</a>
  <ul class="collapse">
  <li><a href="#cluster-statistics" id="toc-cluster-statistics" class="nav-link" data-scroll-target="#cluster-statistics">Cluster Statistics</a></li>
  <li><a href="#cluster-profiling" id="toc-cluster-profiling" class="nav-link" data-scroll-target="#cluster-profiling">Cluster Profiling</a></li>
  <li><a href="#llm-cluster-naming-and-description" id="toc-llm-cluster-naming-and-description" class="nav-link" data-scroll-target="#llm-cluster-naming-and-description">LLM Cluster Naming (and description)</a>
  <ul class="collapse">
  <li><a href="#using-the-openai-api" id="toc-using-the-openai-api" class="nav-link" data-scroll-target="#using-the-openai-api">Using the OpenAI API</a></li>
  <li><a href="#prompt-for-browser-based-llm" id="toc-prompt-for-browser-based-llm" class="nav-link" data-scroll-target="#prompt-for-browser-based-llm">Prompt for Browser Based LLM</a></li>
  </ul></li>
  <li><a href="#save-results" id="toc-save-results" class="nav-link" data-scroll-target="#save-results">Save Results</a></li>
  </ul></li>
  <li><a href="#hierarchical-subclustering" id="toc-hierarchical-subclustering" class="nav-link" data-scroll-target="#hierarchical-subclustering">Hierarchical Subclustering</a>
  <ul class="collapse">
  <li><a href="#selecting-the-number-of-subclusters" id="toc-selecting-the-number-of-subclusters" class="nav-link" data-scroll-target="#selecting-the-number-of-subclusters">Selecting the Number of Subclusters</a></li>
  <li><a href="#run-the-subclustering" id="toc-run-the-subclustering" class="nav-link" data-scroll-target="#run-the-subclustering">Run the subclustering</a></li>
  <li><a href="#visualise-and-save-the-results" id="toc-visualise-and-save-the-results" class="nav-link" data-scroll-target="#visualise-and-save-the-results">Visualise and save the results</a></li>
  <li><a href="#map-the-subclusters" id="toc-map-the-subclusters" class="nav-link" data-scroll-target="#map-the-subclusters">Map the Subclusters</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Creating Cutting-Edge Geodemographic Classifications from Scratch in Python</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Owen Goodwin </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="workshop-content" class="level1">
<h1>Workshop Content</h1>
<p>This notebook contains the full workflow for producing a geodemographic classification from scratch in python using k-means clustering.</p>
<ul>
<li><strong>Data Access and Processing:</strong>
<ul>
<li>Access UK Census data and process using Pandas.</li>
<li>Select a specific region of interest (e.g., Liverpool City Region, Greater Manchester, Greater London).</li>
</ul></li>
<li><strong>Census Data Analysis and Variable selection:</strong>
<ul>
<li>Select relevant Census variables for clustering.</li>
<li>Standardise variables.</li>
<li>Perform correlation &amp; variance analysis to identify potentially redundant variables.</li>
<li>Alternative variable selection methods (e.g., PCA, Autoencoders).</li>
</ul></li>
<li><strong>Clustering:</strong>
<ul>
<li>Determine optimal number of clusters using Clustergrams.</li>
<li>Apply K-Means clustering to classify areas based on selected variables.</li>
<li>Perform top-down hierarchical clustering to divide clusters into subgroups.</li>
</ul></li>
<li><strong>Analytical Techniques:</strong>
<ul>
<li>Use UMAP (Uniform Manifold Approximation and Projection) to visualise high-dimensional embeddings in 2D.</li>
</ul></li>
<li><strong>Visualisation and Communication:</strong>
<ul>
<li>Visualise clusters and subclusters using Kepler.gl for interactive mapping.</li>
<li>Explore cluster characteristics using summary statistics and index scores.</li>
<li>Export results to various formats (GeoPackage, Parquet) for use in GIS software.</li>
</ul></li>
<li><strong>Cluster Naming with LLMs:</strong>
<ul>
<li>Use Large Language Models (LLMs) to generate descriptive names and summaries for clusters based on their characteristics.</li>
</ul></li>
</ul>
</section>
<section id="what-are-geodemographics" class="level1 page-columns page-full">
<h1>What are Geodemographics?</h1>
<p>Geodemographics are a method of classifying geographic areas based on the characteristics of their populations. It involves grouping areas with similar demographic, socio-economic, and lifestyle attributes into distinct categories or clusters. These classifications help in understanding the spatial distribution of different population segments and are widely used in various fields such as marketing, urban planning, public health, and social research. For more information on geodemographics in the UK and the US see: <span class="citation" data-cites="geodemhistory">(<a href="#ref-geodemhistory" role="doc-biblioref">Alexander D. Singleton and Spielman 2014</a>)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="ref-geodemhistory" class="csl-entry" role="listitem">
Singleton, Alexander D., and Seth E. Spielman. 2014. <span>“The Past, Present, and Future of Geodemographic Research in the United States and United Kingdom.”</span> <em>The Professional Geographer</em> 66 (4): 558–67. <a href="https://doi.org/10.1080/00330124.2013.848764">https://doi.org/10.1080/00330124.2013.848764</a>.
</div></div><p>Geodemographic classifications are typically created using statistical techniques such as cluster analysis, in particular k-means clustering. That is the method we will use in this workshop.</p>
<section id="running-the-notebook-yourself" class="level2">
<h2 class="anchored" data-anchor-id="running-the-notebook-yourself">Running the Notebook yourself</h2>
<p>The code used to generate this notebook is available on <a href="https://github.com/ogoodwin505/GeoDem_CartoWorkshop2025">GitHub</a>. Instructions for setting up the environment and downloading the data are provided in the <a href="README.md">README</a> file.</p>
</section>
<section id="install-required-packages-in-colab" class="level2">
<h2 class="anchored" data-anchor-id="install-required-packages-in-colab">Install Required Packages in Colab</h2>
<p>If you are using Google Colab, you will need to install the required packages in the Colab environment. This also enables the custom widget manager required for Kepler.gl to work in Colab. You can do this by uncommenting and running the following code cell in the notebook:</p>
<div id="cell-3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install pandas geopandas pyarrow scikit-learn clustergram umap-learn seaborn plotly matplotlib numpy keplergl openai</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># from google.colab import output</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># output.enable_custom_widget_manager()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Import the necessary libraries and packages.</p>
<div id="cell-5" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> umap.umap_ <span class="im">as</span> umap</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> clustergram <span class="im">import</span> Clustergram</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> colors <span class="im">as</span> mcolors</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keplergl <span class="im">import</span> KeplerGl</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">#set a  random seed for reproducibility</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>random_seed <span class="op">=</span> <span class="dv">507</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">#check that outputs directories exists (if not create it), this is important if you are running the notebook in colab</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'outputs'</span>):</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">'outputs'</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'outputs/maps'</span>):</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">'outputs/maps'</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'outputs/plots'</span>):</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">'outputs/plots'</span>)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'outputs/subclusters'</span>):</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">'outputs/subclusters'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="retrieving-and-preparing-data" class="level1 page-columns page-full">
<h1>Retrieving and Preparing Data</h1>
<p>We will be using Census data from all four UK nations, which are available openly from the respective national statistics agencies (listed below). For this workshop, we will utilise a subset of Census variables that have been unified across the four nations. These variables were used to produce a UK-wide Output Area Classification (OAC) in 2021 <span class="citation" data-cites="2021oac">(<a href="#ref-2021oac" role="doc-biblioref">Wyszomierski et al. 2024</a>)</span>. We will also need boundary data for the Output Areas (OAs). All the data required can be downloaded from the Geographic Data Service Website <a href="https://data.geods.ac.uk/dataset/creating-an-open-geodemographic-classification-using-k-means-clustering-in-python">link</a>, place the file <code>input_data_1.zip</code> in the same directory as the notebook and it will be unzipped below.</p>
<div class="no-row-height column-margin column-container"><div id="ref-2021oac" class="csl-entry" role="listitem">
Wyszomierski, Jakub, Paul A. Longley, Alex D. Singleton, Christopher Gale, and Oliver O’Brien. 2024. <span>“A Neighbourhood Output Area Classification from the 2021 and 2022 UK Censuses.”</span> <em>The Geographical Journal</em> 190 (2): e12550. <a href="https://doi.org/10.1111/geoj.12550">https://doi.org/10.1111/geoj.12550</a>.
</div></div><p>Original Data Sources:</p>
<ol type="1">
<li><strong>ONS Census 2021</strong> (England &amp; Wales):
<ul>
<li><a href="https://www.ons.gov.uk/">ONS Data Service</a></li>
</ul></li>
<li><strong>NRS Census 2022</strong> (Scotland):
<ul>
<li><a href="https://www.scotlandscensus.gov.uk/">Scotland’s Census</a></li>
</ul></li>
<li><strong>NISRA Census 2021</strong> (Northern Ireland):
<ul>
<li><a href="https://www.nisra.gov.uk/">NISRA Website</a></li>
</ul></li>
<li><strong>ONS Geoportal</strong> for boundaries and shapefiles, including clipped EW, Scotland, and Northern Ireland geographies.
<ul>
<li><a href="https://geoportal.statistics.gov.uk/">ONS Geoportal</a></li>
</ul></li>
</ol>
<div id="cell-8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#unzip the data if not already done</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'input_data'</span>):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> zipfile</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> zipfile.ZipFile(<span class="st">'input_data_1.zip'</span>, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        zip_ref.extractall(<span class="st">'./'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[4]</span><span class="ansi-green-fg">, line 4</span>
<span class="ansi-green-fg">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> os.path.exists(<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">input_data</span><span class="ansi-yellow-fg">'</span>):
<span class="ansi-green-fg">      3</span>     <span style="font-weight:bold;color:rgb(0,135,0)">import</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg ansi-bold">zipfile</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">4</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> <span class="ansi-yellow-bg">zipfile</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">ZipFile</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-fg ansi-yellow-bg">input_data_1.zip</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-fg ansi-yellow-bg">r</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-bg">)</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> zip_ref:
<span class="ansi-green-fg">      5</span>         zip_ref.extractall(<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">./</span><span class="ansi-yellow-fg">'</span>)

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">/usr/lib/python3.12/zipfile/__init__.py:1331</span>, in <span class="ansi-cyan-fg">ZipFile.__init__</span><span class="ansi-blue-fg">(self, file, mode, compression, allowZip64, compresslevel, strict_timestamps, metadata_encoding)</span>
<span class="ansi-green-fg">   1329</span> <span style="font-weight:bold;color:rgb(0,135,0)">while</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>:
<span class="ansi-green-fg">   1330</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1331</span>         <span style="color:rgb(0,135,0)">self</span>.fp = <span class="ansi-yellow-bg">io</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">file</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">filemode</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">   1332</span>     <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">OSError</span>:
<span class="ansi-green-fg">   1333</span>         <span style="font-weight:bold;color:rgb(0,135,0)">if</span> filemode <span style="font-weight:bold;color:rgb(175,0,255)">in</span> modeDict:

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'input_data_1.zip'</pre>
</div>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Load the census data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>variable_df <span class="op">=</span> pd.read_parquet(<span class="st">"input_data/uk_census_data.parquet"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#round to 2 decimal places</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>variable_df <span class="op">=</span> variable_df.<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#look at the shape of the dataset</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Input data shape: </span><span class="sc">{</span>variable_df<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#look at the first few rows of the dataset</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>variable_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[5]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#Load the census data</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> variable_df = <span class="ansi-yellow-bg">pd</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_parquet</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">input_data/uk_census_data.parquet</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">      3</span> <span style="font-style:italic;color:rgb(95,135,135)">#round to 2 decimal places</span>
<span class="ansi-green-fg">      4</span> variable_df = variable_df.round(<span class="ansi-green-fg">2</span>)

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parquet.py:669</span>, in <span class="ansi-cyan-fg">read_parquet</span><span class="ansi-blue-fg">(path, engine, columns, storage_options, use_nullable_dtypes, dtype_backend, filesystem, filters, **kwargs)</span>
<span class="ansi-green-fg">    666</span>     use_nullable_dtypes = <span style="font-weight:bold;color:rgb(0,135,0)">False</span>
<span class="ansi-green-fg">    667</span> check_dtype_backend(dtype_backend)
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">669</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">impl</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    670</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">path</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    671</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">columns</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">columns</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    672</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">filters</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">filters</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    673</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">storage_options</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    674</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">use_nullable_dtypes</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">use_nullable_dtypes</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    675</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">dtype_backend</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">dtype_backend</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    676</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">filesystem</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">filesystem</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    677</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    678</span> <span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parquet.py:258</span>, in <span class="ansi-cyan-fg">PyArrowImpl.read</span><span class="ansi-blue-fg">(self, path, columns, filters, use_nullable_dtypes, dtype_backend, storage_options, filesystem, **kwargs)</span>
<span class="ansi-green-fg">    256</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> manager == <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">array</span><span class="ansi-yellow-fg">"</span>:
<span class="ansi-green-fg">    257</span>     to_pandas_kwargs[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">split_blocks</span><span class="ansi-yellow-fg">"</span>] = <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">258</span> path_or_handle, handles, filesystem = <span class="ansi-yellow-bg">_get_path_or_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    259</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">path</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    260</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">filesystem</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    261</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">storage_options</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    262</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">rb</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    263</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    264</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">    265</span>     pa_table = <span style="color:rgb(0,135,0)">self</span>.api.parquet.read_table(
<span class="ansi-green-fg">    266</span>         path_or_handle,
<span class="ansi-green-fg">    267</span>         columns=columns,
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">    270</span>         **kwargs,
<span class="ansi-green-fg">    271</span>     )

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parquet.py:141</span>, in <span class="ansi-cyan-fg">_get_path_or_handle</span><span class="ansi-blue-fg">(path, fs, storage_options, mode, is_dir)</span>
<span class="ansi-green-fg">    131</span> handles = <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">    132</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> (
<span class="ansi-green-fg">    133</span>     <span style="font-weight:bold;color:rgb(175,0,255)">not</span> fs
<span class="ansi-green-fg">    134</span>     <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> is_dir
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">    139</span>     <span style="font-style:italic;color:rgb(95,135,135)"># fsspec resources can also point to directories</span>
<span class="ansi-green-fg">    140</span>     <span style="font-style:italic;color:rgb(95,135,135)"># this branch is used for example when reading from non-fsspec URLs</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">141</span>     handles = <span class="ansi-yellow-bg">get_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    142</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">path_or_handle</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">storage_options</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">storage_options</span>
<span class="ansi-green-fg">    143</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    144</span>     fs = <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">    145</span>     path_or_handle = handles.handle

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/common.py:882</span>, in <span class="ansi-cyan-fg">get_handle</span><span class="ansi-blue-fg">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="ansi-green-fg">    873</span>         handle = <span style="color:rgb(0,135,0)">open</span>(
<span class="ansi-green-fg">    874</span>             handle,
<span class="ansi-green-fg">    875</span>             ioargs.mode,
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">    878</span>             newline=<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">"</span>,
<span class="ansi-green-fg">    879</span>         )
<span class="ansi-green-fg">    880</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    881</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">882</span>         handle = <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">handle</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ioargs</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    883</span>     handles.append(handle)
<span class="ansi-green-fg">    885</span> <span style="font-style:italic;color:rgb(95,135,135)"># Convert BytesIO or file objects passed with an encoding</span>

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'input_data/uk_census_data.parquet'</pre>
</div>
</div>
</div>
<section id="output-areas" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="output-areas">Output Areas</h3>
<p>Output Areas (OAs) <span class="citation" data-cites="oacreation">(<a href="#ref-oacreation" role="doc-biblioref">Martin 2002</a>)</span> (called data zones in northern ireland and small areas in Scotland) are the smallest geographical units available openly in the UK Census. They are designed to have similar population sizes and to maximize the internal social homogeneity of each unit. Each OA typically contains around 100-200 households. These are the base geographical units used in this classification.</p>
<div class="no-row-height column-margin column-container"><div id="ref-oacreation" class="csl-entry" role="listitem">
Martin, David. 2002. <span>“Geography for the 2001 Census in England and Wales.”</span> <em>Population Trends</em>, no. 108: 7—15. <a href="http://europepmc.org/abstract/MED/12138615">http://europepmc.org/abstract/MED/12138615</a>.
</div></div><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/OAexample_new.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:95.0%"></p>
</figure>
</div>
</section>
<section id="spatial-standardisation" class="level3">
<h3 class="anchored" data-anchor-id="spatial-standardisation">Spatial Standardisation</h3>
<p>The data here has been normalised by the total population of each OA to give a percentage. This is important as OAs can vary in population size, and using raw counts would bias the clustering towards more populous areas. We also include the population density of each OA (population / area in sqkm) as a variable.</p>
<div id="cell-11" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>variable_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[6]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> <span class="ansi-yellow-bg">variable_df</span>.head()

<span class="ansi-red-fg">NameError</span>: name 'variable_df' is not defined</pre>
</div>
</div>
</div>
<p>Short descriptions of the variables used in this example are found in the file <code>census_variable_lookup.csv</code>. The full variable descriptions can be found in the <a href="https://www.ons.gov.uk/census/censustransformationprogramme/2021census/2021censususerguide">2021 Census User Guide</a>.</p>
<p>These variables have been selected to provide a broad overview of demographic, socio-economic, and housing characteristics. They cover aspects such as age distribution, household composition, housing type, housing tenure, employment status and education levels.</p>
<div id="cell-13" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#load the lookup file which contains variable descriptions.</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>var_lookup <span class="op">=</span> pd.read_csv(<span class="st">"input_data/census_variable_lookup.csv"</span>)[[<span class="st">"No."</span>,<span class="st">"Variable_Name"</span>,<span class="st">"Domain"</span>]]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>var_lookup</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[7]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#load the lookup file which contains variable descriptions.</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> var_lookup = <span class="ansi-yellow-bg">pd</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_csv</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">input_data/census_variable_lookup.csv</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span>[[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">No.</span><span class="ansi-yellow-fg">"</span>,<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Variable_Name</span><span class="ansi-yellow-fg">"</span>,<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Domain</span><span class="ansi-yellow-fg">"</span>]]
<span class="ansi-green-fg">      3</span> var_lookup

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parsers/readers.py:1026</span>, in <span class="ansi-cyan-fg">read_csv</span><span class="ansi-blue-fg">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, date_format, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options, dtype_backend)</span>
<span class="ansi-green-fg">   1013</span> kwds_defaults = _refine_defaults_read(
<span class="ansi-green-fg">   1014</span>     dialect,
<span class="ansi-green-fg">   1015</span>     delimiter,
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">   1022</span>     dtype_backend=dtype_backend,
<span class="ansi-green-fg">   1023</span> )
<span class="ansi-green-fg">   1024</span> kwds.update(kwds_defaults)
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1026</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_read</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parsers/readers.py:620</span>, in <span class="ansi-cyan-fg">_read</span><span class="ansi-blue-fg">(filepath_or_buffer, kwds)</span>
<span class="ansi-green-fg">    617</span> _validate_names(kwds.get(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">names</span><span class="ansi-yellow-fg">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>))
<span class="ansi-green-fg">    619</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create the parser.</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">620</span> parser = <span class="ansi-yellow-bg">TextFileReader</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    622</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> chunksize <span style="font-weight:bold;color:rgb(175,0,255)">or</span> iterator:
<span class="ansi-green-fg">    623</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> parser

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parsers/readers.py:1620</span>, in <span class="ansi-cyan-fg">TextFileReader.__init__</span><span class="ansi-blue-fg">(self, f, engine, **kwds)</span>
<span class="ansi-green-fg">   1617</span>     <span style="color:rgb(0,135,0)">self</span>.options[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">has_index_names</span><span class="ansi-yellow-fg">"</span>] = kwds[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">has_index_names</span><span class="ansi-yellow-fg">"</span>]
<span class="ansi-green-fg">   1619</span> <span style="color:rgb(0,135,0)">self</span>.handles: IOHandles | <span style="font-weight:bold;color:rgb(0,135,0)">None</span> = <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1620</span> <span style="color:rgb(0,135,0)">self</span>._engine = <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_make_engine</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">engine</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parsers/readers.py:1880</span>, in <span class="ansi-cyan-fg">TextFileReader._make_engine</span><span class="ansi-blue-fg">(self, f, engine)</span>
<span class="ansi-green-fg">   1878</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">b</span><span class="ansi-yellow-fg">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> mode:
<span class="ansi-green-fg">   1879</span>         mode += <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">b</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1880</span> <span style="color:rgb(0,135,0)">self</span>.handles = <span class="ansi-yellow-bg">get_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">   1881</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1882</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1883</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">encoding</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1884</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">compression</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">compression</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1885</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">memory_map</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">memory_map</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1886</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1887</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">encoding_errors</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">strict</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1888</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">storage_options</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1889</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">   1890</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span>.handles <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">   1891</span> f = <span style="color:rgb(0,135,0)">self</span>.handles.handle

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/common.py:873</span>, in <span class="ansi-cyan-fg">get_handle</span><span class="ansi-blue-fg">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="ansi-green-fg">    868</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(handle, <span style="color:rgb(0,135,0)">str</span>):
<span class="ansi-green-fg">    869</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Check whether the filename is to be opened in binary mode.</span>
<span class="ansi-green-fg">    870</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode does not support 'encoding' and 'newline'.</span>
<span class="ansi-green-fg">    871</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ioargs.encoding <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">b</span><span class="ansi-yellow-fg">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> ioargs.mode:
<span class="ansi-green-fg">    872</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Encoding</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">873</span>         handle = <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    874</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">handle</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    875</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">ioargs</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    876</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ioargs</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    877</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    878</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">newline</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    879</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    880</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    881</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode</span>
<span class="ansi-green-fg">    882</span>         handle = <span style="color:rgb(0,135,0)">open</span>(handle, ioargs.mode)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'input_data/census_variable_lookup.csv'</pre>
</div>
</div>
</div>
</section>
<section id="examine-the-data" class="level2">
<h2 class="anchored" data-anchor-id="examine-the-data">Examine the Data</h2>
<p>We can plot the distribution of all the variables to get a sense of their distributions. Many of the variables are highly skewed, which is common for Census data. Skewed variables can be problematic for geodemographics because they cause distance metrics to be dominated by extreme values so effect the quality of clustering.</p>
<div id="cell-15" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use pandas histogram plotting function with seaborn aesthetics</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>nrows <span class="op">=</span> <span class="bu">int</span>(np.ceil(<span class="bu">len</span>(variable_df.columns) <span class="op">/</span> <span class="dv">3</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>variable_df_withnames <span class="op">=</span> variable_df.copy()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>variable_df_withnames.columns <span class="op">=</span> var_lookup[<span class="st">'Variable_Name'</span>].values[:<span class="dv">58</span>]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>variable_df_withnames.hist(bins<span class="op">=</span><span class="dv">30</span>, figsize<span class="op">=</span>(<span class="fl">7.5</span>, nrows<span class="op">*</span><span class="fl">1.5</span>), edgecolor<span class="op">=</span><span class="st">'black'</span>, layout<span class="op">=</span>(nrows, <span class="dv">3</span>))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[8]</span><span class="ansi-green-fg">, line 3</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># Use pandas histogram plotting function with seaborn aesthetics</span>
<span class="ansi-green-fg">      2</span> sns.set_style(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">whitegrid</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">3</span> nrows = <span style="color:rgb(0,135,0)">int</span>(np.ceil(<span style="color:rgb(0,135,0)">len</span>(<span class="ansi-yellow-bg">variable_df</span>.columns) / <span class="ansi-green-fg">3</span>))
<span class="ansi-green-fg">      5</span> variable_df_withnames = variable_df.copy()
<span class="ansi-green-fg">      6</span> variable_df_withnames.columns = var_lookup[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">Variable_Name</span><span class="ansi-yellow-fg">'</span>].values[:<span class="ansi-green-fg">58</span>]

<span class="ansi-red-fg">NameError</span>: name 'variable_df' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="spatial-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="spatial-data">Spatial Data</h2>
<p>We will also need the Output Area boundaries to map the results. The file used here is a GeoPackage containing the 2021 Output Area boundaries for the whole of the UK, clipped to the extent of England and Wales, Scotland, and Northern Ireland. The file has been created by joining the original files for each nation downloaded from the ONS Geoportal.</p>
<div id="cell-17" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#---------</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Import spatial data</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#---------</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>OA_Boundaries <span class="op">=</span> gpd.read_file(<span class="st">"input_data/OA_2021_22_Boundaries.gpkg"</span>).set_index(<span class="st">'OA'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#---------</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Local Authority District (LAD) for region selection</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#---------</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>LAD_Boundaries <span class="op">=</span> gpd.read_file(<span class="st">"input_data/Local_Authority_Districts_December_2022_UK_BGC_V2_5759908710055972638.gpkg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">DataSourceError</span>                           Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[9]</span><span class="ansi-green-fg">, line 4</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#---------</span>
<span class="ansi-green-fg">      2</span> <span style="font-style:italic;color:rgb(95,135,135)"># Import spatial data</span>
<span class="ansi-green-fg">      3</span> <span style="font-style:italic;color:rgb(95,135,135)">#---------</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">4</span> OA_Boundaries = <span class="ansi-yellow-bg">gpd</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_file</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">input_data/OA_2021_22_Boundaries.gpkg</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span>.set_index(<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">OA</span><span class="ansi-yellow-fg">'</span>)
<span class="ansi-green-fg">      5</span> <span style="font-style:italic;color:rgb(95,135,135)">#---------</span>
<span class="ansi-green-fg">      6</span> <span style="font-style:italic;color:rgb(95,135,135)"># Load Local Authority District (LAD) for region selection</span>
<span class="ansi-green-fg">      7</span> <span style="font-style:italic;color:rgb(95,135,135)">#---------</span>
<span class="ansi-green-fg">      8</span> LAD_Boundaries = gpd.read_file(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">input_data/Local_Authority_Districts_December_2022_UK_BGC_V2_5759908710055972638.gpkg</span><span class="ansi-yellow-fg">"</span>)

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/geopandas/io/file.py:316</span>, in <span class="ansi-cyan-fg">_read_file</span><span class="ansi-blue-fg">(filename, bbox, mask, columns, rows, engine, **kwargs)</span>
<span class="ansi-green-fg">    313</span>             filename = response.read()
<span class="ansi-green-fg">    315</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> engine == <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">pyogrio</span><span class="ansi-yellow-fg">"</span>:
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">316</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_read_file_pyogrio</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    317</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">filename</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">bbox</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">bbox</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">mask</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">mask</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">columns</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">columns</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">rows</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">rows</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span>
<span class="ansi-green-fg">    318</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    320</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> engine == <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">fiona</span><span class="ansi-yellow-fg">"</span>:
<span class="ansi-green-fg">    321</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> pd.api.types.is_file_like(filename):

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/geopandas/io/file.py:576</span>, in <span class="ansi-cyan-fg">_read_file_pyogrio</span><span class="ansi-blue-fg">(path_or_bytes, bbox, mask, rows, **kwargs)</span>
<span class="ansi-green-fg">    567</span>     warnings.warn(
<span class="ansi-green-fg">    568</span>         <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">The </span><span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">include_fields</span><span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg"> and </span><span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">ignore_fields</span><span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg"> keywords are deprecated, and </span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">    569</span>         <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">will be removed in a future release. You can use the </span><span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">columns</span><span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg"> keyword </span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">    572</span>         stacklevel=<span class="ansi-green-fg">3</span>,
<span class="ansi-green-fg">    573</span>     )
<span class="ansi-green-fg">    574</span>     kwargs[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">columns</span><span class="ansi-yellow-fg">"</span>] = kwargs.pop(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">include_fields</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">576</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">pyogrio</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_dataframe</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">path_or_bytes</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">bbox</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">bbox</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pyogrio/geopandas.py:275</span>, in <span class="ansi-cyan-fg">read_dataframe</span><span class="ansi-blue-fg">(path_or_buffer, layer, encoding, columns, read_geometry, force_2d, skip_features, max_features, where, bbox, mask, fids, sql, sql_dialect, fid_as_index, use_arrow, on_invalid, arrow_to_pandas_kwargs, **kwargs)</span>
<span class="ansi-green-fg">    270</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> use_arrow:
<span class="ansi-green-fg">    271</span>     <span style="font-style:italic;color:rgb(95,135,135)"># For arrow, datetimes are read as is.</span>
<span class="ansi-green-fg">    272</span>     <span style="font-style:italic;color:rgb(95,135,135)"># For numpy IO, datetimes are read as string values to preserve timezone info</span>
<span class="ansi-green-fg">    273</span>     <span style="font-style:italic;color:rgb(95,135,135)"># as numpy does not directly support timezones.</span>
<span class="ansi-green-fg">    274</span>     kwargs[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">datetime_as_string</span><span class="ansi-yellow-fg">"</span>] = <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">275</span> result = <span class="ansi-yellow-bg">read_func</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    276</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">path_or_buffer</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    277</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">layer</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">layer</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    278</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    279</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">columns</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">columns</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    280</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">read_geometry</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">read_geometry</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    281</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">force_2d</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">gdal_force_2d</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    282</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">skip_features</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">skip_features</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    283</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">max_features</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">max_features</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    284</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">where</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">where</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    285</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">bbox</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">bbox</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    286</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mask</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">mask</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    287</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">fids</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">fids</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    288</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">sql</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">sql</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    289</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">sql_dialect</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">sql_dialect</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    290</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">return_fids</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">fid_as_index</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    291</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    292</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    294</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> use_arrow:
<span class="ansi-green-fg">    295</span>     <span style="font-weight:bold;color:rgb(0,135,0)">import</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg ansi-bold">pyarrow</span><span style="color:rgb(188,188,188)"> </span><span style="font-weight:bold;color:rgb(0,135,0)">as</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg ansi-bold">pa</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pyogrio/raw.py:198</span>, in <span class="ansi-cyan-fg">read</span><span class="ansi-blue-fg">(path_or_buffer, layer, encoding, columns, read_geometry, force_2d, skip_features, max_features, where, bbox, mask, fids, sql, sql_dialect, return_fids, datetime_as_string, **kwargs)</span>
<span class="ansi-green-fg">     59</span> <span style="font-style:italic" class="ansi-yellow-fg">"""Read OGR data source into numpy arrays.</span>
<span class="ansi-green-fg">     60</span> 
<span class="ansi-green-fg">     61</span> <span style="font-style:italic" class="ansi-yellow-fg">IMPORTANT: non-linear geometry types (e.g., MultiSurface) are converted</span>
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">    194</span> 
<span class="ansi-green-fg">    195</span> <span style="font-style:italic" class="ansi-yellow-fg">"""</span>
<span class="ansi-green-fg">    196</span> dataset_kwargs = _preprocess_options_key_value(kwargs) <span style="font-weight:bold;color:rgb(0,135,0)">if</span> kwargs <span style="font-weight:bold;color:rgb(0,135,0)">else</span> {}
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">198</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">ogr_read</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    199</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">get_vsi_path_or_buffer</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">path_or_buffer</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    200</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">layer</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">layer</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    201</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    202</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">columns</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">columns</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    203</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">read_geometry</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">read_geometry</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    204</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">force_2d</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">force_2d</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    205</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">skip_features</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">skip_features</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    206</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">max_features</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">max_features</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">or</span><span class="ansi-yellow-bg"> </span><span class="ansi-green-fg ansi-yellow-bg">0</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    207</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">where</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">where</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    208</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">bbox</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">bbox</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    209</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mask</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">_mask_to_wkb</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mask</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    210</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">fids</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">fids</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    211</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">sql</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">sql</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    212</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">sql_dialect</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">sql_dialect</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    213</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">return_fids</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">return_fids</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    214</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">dataset_kwargs</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">dataset_kwargs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    215</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">datetime_as_string</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">datetime_as_string</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    216</span> <span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">pyogrio/_io.pyx:1313</span>, in <span class="ansi-cyan-fg">pyogrio._io.ogr_read</span><span class="ansi-blue-fg">()</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">pyogrio/_io.pyx:232</span>, in <span class="ansi-cyan-fg">pyogrio._io.ogr_open</span><span class="ansi-blue-fg">()</span>

<span class="ansi-red-fg">DataSourceError</span>: input_data/OA_2021_22_Boundaries.gpkg: No such file or directory</pre>
</div>
</div>
</div>
<section id="selecting-a-region" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="selecting-a-region">Selecting a Region</h3>
<p>For this workshop, we will focus on a specific region of the UK to keep the analysis manageable.</p>
<p>Focusing on a specific region allows us to create a more detailed and relevant geodemographic classification for that area, capturing local nuances and characteristics that may be lost in a broader national classification. For example, a <a href="https://data.geods.ac.uk/dataset/london-oac">London specific OAC</a> was developed as London has a drastically different demographic composition to the rest of the United Kingdom <span class="citation" data-cites="loac">(<a href="#ref-loac" role="doc-biblioref">Alex D. Singleton and Longley 2024</a>)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="ref-loac" class="csl-entry" role="listitem">
Singleton, Alex D., and Paul A. Longley. 2024. <span>“Classifying and Mapping Residential Structure Through the London Output Area Classification.”</span> <em>EPB: Urban Analytics and City Science</em> 51 (5): 1153–64. <a href="https://doi.org/10.1177/23998083241242913">https://doi.org/10.1177/23998083241242913</a>.
</div></div><p>By default we will use the Output Areas within the Liverpool City Region covering the city of liverpool and its surrounding areas. This region is prodominently urban and has a diverse population, making it an interesting case study for geodemographic classification. If running this notebook on your own machine, you can change the region of study from the selection below.</p>
<div id="cell-19" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># region definitions (LAD22CD codes)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>region_lads <span class="op">=</span> {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Greater Manchester"</span>: [</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E08000001"</span>,<span class="st">"E08000002"</span>,<span class="st">"E08000003"</span>,<span class="st">"E08000004"</span>,<span class="st">"E08000005"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E08000006"</span>,<span class="st">"E08000007"</span>,<span class="st">"E08000008"</span>,<span class="st">"E08000009"</span>,<span class="st">"E08000010"</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Liverpool City Region"</span>: [</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E06000006"</span>,<span class="st">"E08000011"</span>,<span class="st">"E08000012"</span>,<span class="st">"E08000013"</span>,<span class="st">"E08000014"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E08000015"</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Greater London"</span>: [</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E09000001"</span>,<span class="st">"E09000002"</span>,<span class="st">"E09000003"</span>,<span class="st">"E09000004"</span>,<span class="st">"E09000005"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E09000006"</span>,<span class="st">"E09000007"</span>,<span class="st">"E09000008"</span>,<span class="st">"E09000009"</span>,<span class="st">"E09000010"</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E09000011"</span>,<span class="st">"E09000012"</span>,<span class="st">"E09000013"</span>,<span class="st">"E09000014"</span>,<span class="st">"E09000015"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E09000016"</span>,<span class="st">"E09000017"</span>,<span class="st">"E09000018"</span>,<span class="st">"E09000019"</span>,<span class="st">"E09000020"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E09000021"</span>,<span class="st">"E09000022"</span>,<span class="st">"E09000023"</span>,<span class="st">"E09000024"</span>,<span class="st">"E09000025"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E09000026"</span>,<span class="st">"E09000027"</span>,<span class="st">"E09000028"</span>,<span class="st">"E09000029"</span>,<span class="st">"E09000030"</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"E09000031"</span>,<span class="st">"E09000032"</span>,<span class="st">"E09000033"</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Scotland"</span>: [</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S12000005"</span>,<span class="st">"S12000006"</span>,<span class="st">"S12000008"</span>,<span class="st">"S12000010"</span>,<span class="st">"S12000011"</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S12000013"</span>,<span class="st">"S12000014"</span>,<span class="st">"S12000017"</span>,<span class="st">"S12000018"</span>,<span class="st">"S12000019"</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S12000020"</span>,<span class="st">"S12000021"</span>,<span class="st">"S12000023"</span>,<span class="st">"S12000026"</span>,<span class="st">"S12000027"</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S12000028"</span>,<span class="st">"S12000029"</span>,<span class="st">"S12000030"</span>,<span class="st">"S12000033"</span>,<span class="st">"S12000034"</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S12000035"</span>,<span class="st">"S12000036"</span>,<span class="st">"S12000038"</span>,<span class="st">"S12000039"</span>,<span class="st">"S12000040"</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S12000041"</span>,<span class="st">"S12000042"</span>,<span class="st">"S12000045"</span>,<span class="st">"S12000047"</span>,<span class="st">"S12000048"</span>,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"S12000049"</span>,<span class="st">"S12000050"</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Northern Ireland"</span>: [</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N09000001"</span>,<span class="st">"N09000002"</span>,<span class="st">"N09000003"</span>,<span class="st">"N09000004"</span>,<span class="st">"N09000005"</span>,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N09000006"</span>,<span class="st">"N09000007"</span>,<span class="st">"N09000008"</span>,<span class="st">"N09000009"</span>,<span class="st">"N09000010"</span>,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N09000011"</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Wales"</span>: [</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"W06000001"</span>,<span class="st">"W06000002"</span>,<span class="st">"W06000003"</span>,<span class="st">"W06000004"</span>,<span class="st">"W06000005"</span>,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"W06000006"</span>,<span class="st">"W06000007"</span>,<span class="st">"W06000008"</span>,<span class="st">"W06000009"</span>,<span class="st">"W06000010"</span>,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"W06000011"</span>,<span class="st">"W06000012"</span>,<span class="st">"W06000013"</span>,<span class="st">"W06000014"</span>,<span class="st">"W06000015"</span>,</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"W06000016"</span>,<span class="st">"W06000017"</span>,<span class="st">"W06000018"</span>,<span class="st">"W06000019"</span>,<span class="st">"W06000020"</span>,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"W06000021"</span>,<span class="st">"W06000022"</span>,<span class="st">"W06000023"</span>,<span class="st">"W06000024"</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Selecting the region of interest:</p>
<div id="cell-21" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Choose region from the list above by uncommenting the relevant line</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>lad_codes <span class="op">=</span> region_lads[<span class="st">"Liverpool City Region"</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># #or eg:</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># lad_codes = region_lads["Greater Manchester"]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-22" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>selected_lads <span class="op">=</span> LAD_Boundaries[LAD_Boundaries[<span class="st">"LAD22CD"</span>].isin(lad_codes)]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join to filter only intersecting OAs</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>oas_region <span class="op">=</span> gpd.sjoin(OA_Boundaries, selected_lads[[<span class="st">"geometry"</span>]], predicate<span class="op">=</span><span class="st">"intersects"</span>).drop(columns<span class="op">=</span>[<span class="st">"index_right"</span>])</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># drop duplicates (one which intersect with two LADs) using index</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>oas_region <span class="op">=</span> oas_region[<span class="op">~</span>oas_region.index.duplicated(keep<span class="op">=</span><span class="st">'first'</span>)]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Merge OA polygons with your variable data keeping only those with matching OAs in the region</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>oas_region_vars <span class="op">=</span> oas_region.join(variable_df, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># #keep only OAs in our region</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>variable_df_region<span class="op">=</span>variable_df.loc[variable_df.index.isin(oas_region.index)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[12]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> selected_lads = <span class="ansi-yellow-bg">LAD_Boundaries</span>[LAD_Boundaries[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">LAD22CD</span><span class="ansi-yellow-fg">"</span>].isin(lad_codes)]
<span class="ansi-green-fg">      3</span> <span style="font-style:italic;color:rgb(95,135,135)"># Spatial join to filter only intersecting OAs</span>
<span class="ansi-green-fg">      4</span> oas_region = gpd.sjoin(OA_Boundaries, selected_lads[[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">geometry</span><span class="ansi-yellow-fg">"</span>]], predicate=<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">intersects</span><span class="ansi-yellow-fg">"</span>).drop(columns=[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">index_right</span><span class="ansi-yellow-fg">"</span>])

<span class="ansi-red-fg">NameError</span>: name 'LAD_Boundaries' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="map-the-area" class="level3">
<h3 class="anchored" data-anchor-id="map-the-area">Map the Area</h3>
<p>We will use Kepler.gl to visualise the Output Areas in our selected region. Kepler.gl is an open-source geospatial analysis tool that allows for interactive mapping and visualisation of large datasets.</p>
<div id="cell-24" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#code to enable kepler in colab</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Javascript</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>display(Javascript(<span class="st">'''</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">  google.colab.widgets.installCustomManager('https://ssl.gstatic.com/colaboratory-static/widgets/colab-cdn-widget-manager/6a14374f468a145a/manager.min.js');</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">'''</span>))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Calculate region centroid for map centering ---</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.ops <span class="im">import</span> unary_union</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>region_geom <span class="op">=</span> unary_union(</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    LAD_Boundaries.loc[LAD_Boundaries[<span class="st">"LAD22CD"</span>].isin(lad_codes), <span class="st">"geometry"</span>]</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>region_centroid <span class="op">=</span> region_geom.centroid</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>centroid_ll <span class="op">=</span> gpd.GeoSeries([region_centroid], crs<span class="op">=</span>LAD_Boundaries.crs).to_crs(epsg<span class="op">=</span><span class="dv">4326</span>).iloc[<span class="dv">0</span>]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>centroid_lat, centroid_lon <span class="op">=</span> centroid_ll.y, centroid_ll.x</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Quick Kepler map ---</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>area_map_ <span class="op">=</span> KeplerGl(</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    config<span class="op">=</span>{</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"version"</span>: <span class="st">"v1"</span>,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"config"</span>: {</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mapState"</span>: {</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>               <span class="st">'latitude'</span>: centroid_lat,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">'longitude'</span>: centroid_lon,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"zoom"</span>: <span class="dv">9</span>,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"pitch"</span>: <span class="dv">0</span>,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">"bearing"</span>: <span class="dv">0</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Add your layer</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>area_map_.add_data(data<span class="op">=</span>oas_region_vars.reset_index(), name<span class="op">=</span><span class="st">"OAs in Region"</span>)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to export to a standalone HTML:</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>area_map_.save_to_html(file_name<span class="op">=</span><span class="st">"outputs/maps/region_oas_map.html"</span>)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Show inside Jupyter</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>display(area_map_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<iframe src="outputs/maps/region_oas_map.html" width="100%" height="650" style="border:none;">
</iframe>
</section>
</section>
</section>
<section id="transform-and-standardise-variables" class="level1">
<h1>Transform and Standardise Variables</h1>
<p>Before applying clustering algorithms, it is important to transform and standardise the data to ensure that all variables contribute equally to the analysis.</p>
<p>The function below applies two transformations to a dataframe (applied column-wise):</p>
<ol type="1">
<li><strong>Inverse Hyperbolic Sine (IHS) transform</strong><br>
</li>
<li><strong>Min–Max scaling to [0, 1]</strong></li>
</ol>
<section id="mathematical-definitions" class="level3">
<h3 class="anchored" data-anchor-id="mathematical-definitions">Mathematical definitions</h3>
<p><strong>Inverse hyperbolic sine (IHS, a.k.a. arcsinh):</strong><br>
- Similar to a log transform but works with zero and negative values.<br>
- Helps stabilise variance and make skewed distributions more normal-like.</p>
<p><span class="math display">\[
\mathrm{arcsinh}(x) = \ln\!\big(x + \sqrt{x^{2}+1}\big)
\]</span></p>
<p><strong>Properties:</strong> - For large (|x|):<br>
<span class="math display">\[
  \mathrm{arcsinh}(x) \approx \ln(2|x|)
  \]</span> (behaves like log).</p>
<ul>
<li>Near (0):<br>
<span class="math display">\[
\mathrm{arcsinh}(x) \approx x
\]</span></li>
</ul>
<p><strong>Min–Max scaling (applied per column after IHS):</strong></p>
<p><span class="math display">\[
x' = \frac{x - \min(x)}{\max(x) - \min(x)}
\]</span></p>
<ul>
<li>Rescales all values into the range ([0, 1]).<br>
</li>
<li>Useful for comparing variables with different units/scales.</li>
</ul>
<div id="cell-27" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_and_standardise_data(df):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Apply inverse hyperbolic sine transform, to account for non-normality</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">    and then range standardise using min-max scaling to the dataframe."""</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> np.arcsinh(df)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    denom <span class="op">=</span> df.<span class="bu">max</span>() <span class="op">-</span> df.<span class="bu">min</span>()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> (df <span class="op">-</span> df.<span class="bu">min</span>()) <span class="op">/</span> denom.replace(<span class="dv">0</span>, <span class="dv">1</span>)  <span class="co"># prevent divide-by-zero</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform the input data</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>transformed_variable_df <span class="op">=</span> transform_and_standardise_data(variable_df_region)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[14]</span><span class="ansi-green-fg">, line 10</span>
<span class="ansi-green-fg">      7</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> df
<span class="ansi-green-fg">      9</span> <span style="font-style:italic;color:rgb(95,135,135)"># Transform the input data</span>
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">10</span> transformed_variable_df = transform_and_standardise_data(<span class="ansi-yellow-bg">variable_df_region</span>)

<span class="ansi-red-fg">NameError</span>: name 'variable_df_region' is not defined</pre>
</div>
</div>
</div>
</section>
</section>
<section id="variable-selection" class="level1 page-columns page-full">
<h1>Variable Selection</h1>
<p>In geodemographics, <strong>variable selection</strong> is crucial to turn large datasets (like the UK Census) with 100s of variables into meaningful clusters.<br>
The nature of clustering means the high-dimensional space can be sparse and noisy, so reducing the number of variables helps improve cluster quality and interpretability.</p>
<p>Key points:<br>
- <strong>Intention</strong> – variables depend on the purpose of the geodem (e.g.&nbsp;retail vs.&nbsp;health).<br>
- <strong>Correlation</strong> – drop highly correlated variables to avoid redundancy.<br>
- <strong>Variance</strong> – keep variables that vary across places (so they can distinguish areas).<br>
- <strong>Expert choice</strong> – ensure selected variables are socially meaningful.</p>
<p>Here we are using a <strong>broad, pre-selected dataset</strong> which was used for the UK OAC 2021 classification. So we expect the variables to be broadly suitable for our region of interest.</p>
<p>New methods include:<br>
- <strong>Automated variable selection</strong> <span class="citation" data-cites="pcavarselect">(<a href="#ref-pcavarselect" role="doc-biblioref">Liu, Singleton, and Arribas‐Bel 2019</a>)</span> – uses statistical procedure to determine a subset of variables which produce the best clustering results.<br>
- <strong>Autoencoders</strong> – Use neural networks to compress all variables into a smaller set of features, while preserving the most important patterns.</p>
<div class="no-row-height column-margin column-container"><div id="ref-pcavarselect" class="csl-entry" role="listitem">
Liu, Yunzhe, Alex Singleton, and Daniel Arribas‐Bel. 2019. <span>“A Principal Component Analysis (PCA)‐based Framework for Automated Variable Selection in Geodemographic Classification.”</span> <em>Geo‐spatial Information Science</em> 22 (4): 251–64. <a href="https://doi.org/10.1080/10095020.2019.1621549">https://doi.org/10.1080/10095020.2019.1621549</a>.
</div></div><section id="correlation-variance-analysis" class="level2">
<h2 class="anchored" data-anchor-id="correlation-variance-analysis">Correlation &amp; Variance Analysis</h2>
<div id="cell-29" class="cell" data-out.width="100%" data-execution_count="15">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>transformed_variable_df_withnames <span class="op">=</span> transformed_variable_df.copy()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>transformed_variable_df_withnames.columns <span class="op">=</span> [var_lookup.set_index(<span class="st">"No."</span>)[<span class="st">"Variable_Name"</span>].to_dict().get(col, col) <span class="cf">for</span> col <span class="kw">in</span> transformed_variable_df.columns]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Correlation Check ---</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="op">=</span> transformed_variable_df_withnames.corr()</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Interactive heatmap with Plotly ---</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.imshow(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    corr_matrix.values,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    color_continuous_scale<span class="op">=</span><span class="st">"RdBu_r"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    zmin<span class="op">=-</span><span class="dv">1</span>, zmax<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Correlation Heatmap"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>corr_matrix.columns,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>corr_matrix.columns,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add hover names for tooltips</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>fig.update_traces(</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    hovertemplate<span class="op">=</span><span class="st">"&lt;b&gt;%</span><span class="sc">{x}</span><span class="st">&lt;/b&gt; vs &lt;b&gt;%</span><span class="sc">{y}</span><span class="st">&lt;/b&gt;&lt;br&gt;Correlation: %</span><span class="sc">{z:.3f}</span><span class="st">&lt;extra&gt;&lt;/extra&gt;"</span>,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Hide x/y tick labels but keep tooltips</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>fig.update_xaxes(showticklabels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>fig.update_yaxes(showticklabels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">700</span>,  </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">700</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    coloraxis_colorbar<span class="op">=</span><span class="bu">dict</span>(<span class="bu">len</span><span class="op">=</span><span class="fl">0.8</span>, thickness<span class="op">=</span><span class="dv">15</span>),</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    margin<span class="op">=</span><span class="bu">dict</span>(l<span class="op">=</span><span class="dv">40</span>, r<span class="op">=</span><span class="dv">40</span>, t<span class="op">=</span><span class="dv">60</span>, b<span class="op">=</span><span class="dv">40</span>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>fig.show()</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Find highly correlated pairs (print each pair twice) ---</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> corr_matrix.columns</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># consider only upper triangle to get unique unordered pairs (i &lt; j)</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>upper_mask <span class="op">=</span> np.triu(np.ones(corr_matrix.shape, dtype<span class="op">=</span><span class="bu">bool</span>), k<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="co"># build mask for correlations above 0.95 (and exclude perfect 1.0)</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>corr_threshold <span class="op">=</span> <span class="fl">0.95</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>corr_vals <span class="op">=</span> corr_matrix.values</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co"># consider only upper triangle unique pairs (i &lt; j) and print each once once</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> ((corr_vals <span class="op">&gt;</span> corr_threshold) <span class="op">&amp;</span> upper_mask)</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>pairs <span class="op">=</span> np.column_stack(np.where(mask))</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, j <span class="kw">in</span> pairs:</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    col_i, col_j <span class="op">=</span> cols[i], cols[j]</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    val <span class="op">=</span> corr_matrix.iat[i, j]</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"High correlation between </span><span class="sc">{</span>col_i<span class="sc">}</span><span class="ss"> and </span><span class="sc">{</span>col_j<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>val<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Variance Check ---</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>variances <span class="op">=</span> transformed_variable_df_withnames.var()</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a><span class="co">#plot the variances</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>variances.sort_values().plot(kind<span class="op">=</span><span class="st">'bar'</span>)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Variance'</span>)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Variance of Each Variable'</span>)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[15]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> transformed_variable_df_withnames = <span class="ansi-yellow-bg">transformed_variable_df</span>.copy()
<span class="ansi-green-fg">      2</span> transformed_variable_df_withnames.columns = [var_lookup.set_index(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">No.</span><span class="ansi-yellow-fg">"</span>)[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Variable_Name</span><span class="ansi-yellow-fg">"</span>].to_dict().get(col, col) <span style="font-weight:bold;color:rgb(0,135,0)">for</span> col <span style="font-weight:bold;color:rgb(175,0,255)">in</span> transformed_variable_df.columns]
<span class="ansi-green-fg">      4</span> <span style="font-style:italic;color:rgb(95,135,135)"># --- Correlation Check ---</span>

<span class="ansi-red-fg">NameError</span>: name 'transformed_variable_df' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="selecting-variables" class="level2">
<h2 class="anchored" data-anchor-id="selecting-variables">Selecting Variables</h2>
<p>If we want to remove any variables we can do so here. This could be based on the analysis above or to tailor the classification to a specific purpose.</p>
<div id="cell-31" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>drop_vars <span class="op">=</span> []<span class="co"># No variables to drop, use variable selection as is.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for northern ireland bangladeshi ethnicity variable should be removed as variation is zero (no counts)</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># drop_vars = ['v12']</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>cleaned_variable_df <span class="op">=</span> transformed_variable_df.drop(columns<span class="op">=</span>drop_vars)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># We could also focus on a specific theme, for example education and work </span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># related variables only:</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ed_work_vars = ['v45','v46','v47','v48','v49','v50','v51','v52','v53',</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 'v54','v55','v56', 'v57','v58','v59','v60']</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># cleaned_variable_df = transformed_variable_df[ed_work_vars]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[16]</span><span class="ansi-green-fg">, line 5</span>
<span class="ansi-green-fg">      1</span> drop_vars = []<span style="font-style:italic;color:rgb(95,135,135)"># No variables to drop, use variable selection as is.</span>
<span class="ansi-green-fg">      2</span> <span style="font-style:italic;color:rgb(95,135,135)"># for northern ireland bangladeshi ethnicity variable should be removed as variation is zero (no counts)</span>
<span class="ansi-green-fg">      3</span> <span style="font-style:italic;color:rgb(95,135,135)"># drop_vars = ['v12']</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">5</span> cleaned_variable_df = <span class="ansi-yellow-bg">transformed_variable_df</span>.drop(columns=drop_vars)
<span class="ansi-green-fg">      7</span> <span style="font-style:italic;color:rgb(95,135,135)"># We could also focus on a specific theme, for example education and work </span>
<span class="ansi-green-fg">      8</span> <span style="font-style:italic;color:rgb(95,135,135)"># related variables only:</span>
<span class="ansi-green-fg">      9</span> <span style="font-style:italic;color:rgb(95,135,135)"># ed_work_vars = ['v45','v46','v47','v48','v49','v50','v51','v52','v53',</span>
<span class="ansi-green-fg">     10</span> <span style="font-style:italic;color:rgb(95,135,135)"># 'v54','v55','v56', 'v57','v58','v59','v60']</span>
<span class="ansi-green-fg">     11</span> <span style="font-style:italic;color:rgb(95,135,135)"># cleaned_variable_df = transformed_variable_df[ed_work_vars]</span>

<span class="ansi-red-fg">NameError</span>: name 'transformed_variable_df' is not defined</pre>
</div>
</div>
</div>
</section>
</section>
<section id="k-means-clustering" class="level1 page-columns page-full">
<h1>K-Means Clustering</h1>
<p>K-means clustering is the most commonly used clustering algorithm for geodemographic classification. It partitions a dataset into <em>k</em> groups (clusters), where each observation belongs to the cluster with the nearest mean (centroid). The algorithm iteratively updates cluster assignments and centroids until convergence.</p>
<p><strong>How it works (simplified):</strong></p>
<ol type="1">
<li>Choose the number of clusters (<em>k</em>).<br>
</li>
<li>Initialise <em>k</em> centroids (usually at random points in the data space).</li>
<li>Assign each data point to the nearest centroid.<br>
</li>
<li>Update centroids as the mean of the points in each cluster.<br>
</li>
<li>Repeat steps 3–4 until assignments no longer change (or improvement is below a threshold).</li>
</ol>
<p><strong>Strengths:</strong></p>
<ul>
<li>Simple and computationally efficient.<br>
</li>
<li>Works well when clusters are roughly spherical and similar in size.</li>
</ul>
<p><strong>Limitations:</strong></p>
<ul>
<li>Requires specifying <em>k</em> in advance.<br>
</li>
<li>Sensitive to outliers and scaling of features.<br>
</li>
<li>Assumes clusters are convex<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> and isotropic<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>; k‑means effectively assumes clusters are roughly spherical with similar variance in every direction, which may not hold in real data.</li>
<li>Dimensionality: K-means can struggle in very high-dimensional spaces due to the “curse of dimensionality”</li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;A set is convex if, for any two points in the set, the straight line between them lies entirely within the set.</p></div><div id="fn2"><p><sup>2</sup>&nbsp;Having uniform properties in all directions</p></div></div><p>More details and examples can be found here: <a href="https://scikit-learn.org/stable/modules/clustering.html#k-means">Scikit-learn: K-Means</a></p>
<section id="choosing-the-number-of-clusters-k---clustergrams" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="choosing-the-number-of-clusters-k---clustergrams">Choosing the Number of Clusters (k) - Clustergrams</h2>
<p>When using k-means clustering, one of the key decisions is selecting the optimal number of clusters (k). This choice can significantly impact the quality and interpretability of the resulting geodemographic classification. Key considerations when choosing k:</p>
<ul>
<li>Each cluster be as homogeneous as possible.</li>
<li>Each cluster should be as distinct from the others as possible.</li>
<li>The clusters should be as evenly sized as possible.</li>
</ul>
<p>Clustergrams <span class="citation" data-cites="clustergram">(<a href="#ref-clustergram" role="doc-biblioref">Fleischmann 2023</a>)</span> are visualisation technique that shows how cluster assignments change as you increase the number of clusters (k). This helps you to understand the structure in very high-dimensional space in the following ways:</p>
<div class="no-row-height column-margin column-container"><div id="ref-clustergram" class="csl-entry" role="listitem">
Fleischmann, Martin. 2023. <span>“Clustergram: Visualization and Diagnostics for Cluster Analysis.”</span> <em>Journal of Open Source Software</em> 8 (89): 5240. <a href="https://doi.org/10.21105/joss.05240">https://doi.org/10.21105/joss.05240</a>.
</div></div><ul>
<li><strong>Cluster separation</strong>: Helps you to determine the right number of clusters by visualising how cleanly clusters separate<br>
</li>
<li><strong>Cluster stability</strong>: Shows which clusters persist across different k values (stable long lines) vs.&nbsp;those which are artifacts of over-clustering (short, erratic lines)<br>
</li>
<li><strong>Split patterns</strong>: Reveals the natural hierarchy in the data by showing how clusters subdivide</li>
</ul>
<p>Further guidance on interpreting clustergrams and choosing the number of clusters can be found here: <a href="https://clustergram.readthedocs.io/en/stable/notebooks/introduction.html">Clustergram</a></p>
<div id="cell-33" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since k-means is sensitive to initialization, `n_init` determines the number of </span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># times the algorithm runs with different centroid seeds. The final result is the </span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># best outcome based on inertia/WCSS (within-cluster sum of squares).</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>n_init <span class="op">=</span> <span class="dv">100</span>  <span class="co"># Use a low value for quick testing, increase (~100) for final results</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>cgram <span class="op">=</span> Clustergram(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>), n_init<span class="op">=</span>n_init, random_state<span class="op">=</span>random_seed,verbose<span class="op">=</span><span class="va">False</span>)  <span class="co"># Initialize clustergram model</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>cgram.fit(cleaned_variable_df)  <span class="co"># Fit model to data</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>cgram.plot()  <span class="co"># Generate plot</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">"outputs/plots/supergroup_clustergram.png"</span>)  <span class="co"># Save figure</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>plt.show()  <span class="co"># Display plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[17]</span><span class="ansi-green-fg">, line 6</span>
<span class="ansi-green-fg">      4</span> n_init = <span class="ansi-green-fg">100</span>  <span style="font-style:italic;color:rgb(95,135,135)"># Use a low value for quick testing, increase (~100) for final results</span>
<span class="ansi-green-fg">      5</span> cgram = Clustergram(<span style="color:rgb(0,135,0)">range</span>(<span class="ansi-green-fg">1</span>, <span class="ansi-green-fg">10</span>), n_init=n_init, random_state=random_seed,verbose=<span style="font-weight:bold;color:rgb(0,135,0)">False</span>)  <span style="font-style:italic;color:rgb(95,135,135)"># Initialize clustergram model</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">6</span> cgram.fit(<span class="ansi-yellow-bg">cleaned_variable_df</span>)  <span style="font-style:italic;color:rgb(95,135,135)"># Fit model to data</span>
<span class="ansi-green-fg">      7</span> cgram.plot()  <span style="font-style:italic;color:rgb(95,135,135)"># Generate plot</span>
<span class="ansi-green-fg">      8</span> plt.savefig(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">outputs/plots/supergroup_clustergram.png</span><span class="ansi-yellow-fg">"</span>)  <span style="font-style:italic;color:rgb(95,135,135)"># Save figure</span>

<span class="ansi-red-fg">NameError</span>: name 'cleaned_variable_df' is not defined</pre>
</div>
</div>
</div>
<p>Choose the number of clusters (k) based on the clustergram above.</p>
<div id="cell-35" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the number of clusters (K). Choose K based on the clustergram plot.</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>num_clusters <span class="op">=</span> <span class="dv">5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="apply-k-means-clustering" class="level2">
<h2 class="anchored" data-anchor-id="apply-k-means-clustering">Apply K-Means Clustering</h2>
<div id="cell-37" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># num_clusters (int): The number of clusters (K) to create.</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># n_init (int): Number of times the K-means algorithm runs with different initial </span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                 centroid seeds. The best result based on inertia/WCSS is chosen. </span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                 A higher value (e.g., ~1000) is recommended for final results, </span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                 but a lower value can be used for testing.</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>n_init <span class="op">=</span> <span class="dv">1000</span> <span class="co"># Use a low value for quick testing, increase (~100) for final results</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>output_filepath <span class="op">=</span> <span class="st">"outputs/supergroups_clusteroutput.csv"</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the K-means model</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>kmeans_model <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>num_clusters,init<span class="op">=</span><span class="st">"random"</span>, random_state<span class="op">=</span>random_seed, n_init<span class="op">=</span>n_init)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model and assign clusters to a new dataframe which is a copy of the input data</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>supergrouped_variable_df <span class="op">=</span> cleaned_variable_df.copy()</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>supergrouped_variable_df[<span class="st">'cluster'</span>] <span class="op">=</span> kmeans_model.fit_predict(cleaned_variable_df)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure output directory exists</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>os.makedirs(os.path.dirname(output_filepath), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the cluster assignments to a CSV file</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>supergrouped_variable_df[[<span class="st">'cluster'</span>]].to_csv(output_filepath)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Map numeric labels to letters</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>label_map <span class="op">=</span> {i: <span class="bu">chr</span>(<span class="dv">65</span> <span class="op">+</span> i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_clusters)}  <span class="co"># 0-&gt;A, 1-&gt;B, etc.</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>supergrouped_variable_df[<span class="st">'cluster'</span>] <span class="op">=</span> supergrouped_variable_df[<span class="st">'cluster'</span>].<span class="bu">map</span>(label_map)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co">#view the output</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>supergrouped_variable_df[<span class="st">"cluster"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[19]</span><span class="ansi-green-fg">, line 13</span>
<span class="ansi-green-fg">     11</span> kmeans_model = KMeans(n_clusters=num_clusters,init=<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">random</span><span class="ansi-yellow-fg">"</span>, random_state=random_seed, n_init=n_init)
<span class="ansi-green-fg">     12</span> <span style="font-style:italic;color:rgb(95,135,135)"># Fit the model and assign clusters to a new dataframe which is a copy of the input data</span>
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">13</span> supergrouped_variable_df = <span class="ansi-yellow-bg">cleaned_variable_df</span>.copy()
<span class="ansi-green-fg">     14</span> supergrouped_variable_df[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">cluster</span><span class="ansi-yellow-fg">'</span>] = kmeans_model.fit_predict(cleaned_variable_df)
<span class="ansi-green-fg">     15</span> <span style="font-style:italic;color:rgb(95,135,135)"># Ensure output directory exists</span>

<span class="ansi-red-fg">NameError</span>: name 'cleaned_variable_df' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="mapping-the-clusters" class="level2">
<h2 class="anchored" data-anchor-id="mapping-the-clusters">Mapping the Clusters</h2>
<p>We can visualise the clusters on a map to see their spatial distribution.</p>
<iframe src="outputs/maps/cluster_map.html" width="100%" height="650" style="border:none;">
</iframe>
</section>
<section id="umap-visualisation" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="umap-visualisation">UMAP Visualisation</h2>
<p>We can use UMAP (Uniform Manifold Approximation and Projection) <span class="citation" data-cites="umap">(<a href="#ref-umap" role="doc-biblioref">McInnes, Healy, and Melville 2020</a>)</span> to visualise the high-dimensional Census data in 2D. UMAP is a dimensionality reduction technique that preserves both local and global structure in the data, making it well-suited for visualising complex datasets like Census data.</p>
<div class="no-row-height column-margin column-container"><div id="ref-umap" class="csl-entry" role="listitem">
McInnes, Leland, John Healy, and James Melville. 2020. <span>“UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction.”</span> <a href="https://arxiv.org/abs/1802.03426">https://arxiv.org/abs/1802.03426</a>.
</div></div><div id="cell-42" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Features = all columns except the cluster label</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> supergrouped_variable_df.columns <span class="cf">if</span> c <span class="op">!=</span> <span class="st">'cluster'</span>]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract features and labels  (transformed)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> supergrouped_variable_df[features].values</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> supergrouped_variable_df[<span class="st">'cluster'</span>].values</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit UMAP</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply UMAP to reduce 64 dimensions to 2D</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>reducer <span class="op">=</span> umap.UMAP(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    n_neighbors<span class="op">=</span><span class="dv">30</span>,        <span class="co"># Numbers of neighbours</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    min_dist<span class="op">=</span><span class="fl">0.0</span>,          <span class="co"># Allow points to be closer together</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    n_components<span class="op">=</span><span class="dv">2</span>,        <span class="co"># Reduce to 2D for visualsation</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">508</span>,       <span class="co"># For reproducible results</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    metric<span class="op">=</span><span class="st">'cosine'</span>,       <span class="co"># Cosine similarity </span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    init<span class="op">=</span><span class="st">'random'</span>,         <span class="co"># Use random initialisation</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    n_epochs<span class="op">=</span><span class="dv">500</span>,          <span class="co"># More epochs for better convergence</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    spread<span class="op">=</span><span class="fl">1.0</span>,            <span class="co"># Controls how tightly points are packed</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span>          <span class="co"># Show progress</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>embedding <span class="op">=</span> reducer.fit_transform(X)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>umap_results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'UMAP1'</span>: embedding[:, <span class="dv">0</span>],</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'UMAP2'</span>: embedding[:, <span class="dv">1</span>],</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Cluster'</span>: labels</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the UMAP results</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>umap_results.to_parquet(<span class="st">'outputs/umap_results.parquet'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[21]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># Features = all columns except the cluster label</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> features = [c <span style="font-weight:bold;color:rgb(0,135,0)">for</span> c <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span class="ansi-yellow-bg">supergrouped_variable_df</span>.columns <span style="font-weight:bold;color:rgb(0,135,0)">if</span> c != <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">cluster</span><span class="ansi-yellow-fg">'</span>]
<span class="ansi-green-fg">      3</span> <span style="font-style:italic;color:rgb(95,135,135)"># Extract features and labels  (transformed)</span>
<span class="ansi-green-fg">      4</span> X = supergrouped_variable_df[features].values

<span class="ansi-red-fg">NameError</span>: name 'supergrouped_variable_df' is not defined</pre>
</div>
</div>
</div>
<div id="cell-43" class="cell" data-out.width="100%" data-execution_count="22">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define colours for each cluster - same as earlier map</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>colours <span class="op">=</span> {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A"</span>: <span class="st">'#8dd3c7'</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B"</span>: <span class="st">'#ffffb3'</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C"</span>: <span class="st">'#bebada'</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"D"</span>: <span class="st">'#fb8072'</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"E"</span>: <span class="st">'#fdb462'</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"F"</span>: <span class="st">"#235477"</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G"</span>: <span class="st">'#fccde5'</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"H"</span>: <span class="st">'#d9d9d9'</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"I"</span>: <span class="st">'#bc80bd'</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"J"</span>: <span class="st">'#ccebc5'</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create interactive UMAP scatter plot</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>fig_interactive <span class="op">=</span> px.scatter(</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    umap_results,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'UMAP1'</span>,</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">'UMAP2'</span>,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'Cluster'</span>,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    category_orders<span class="op">=</span>{<span class="st">"Cluster"</span>: <span class="bu">sorted</span>(umap_results[<span class="st">"Cluster"</span>].unique())},  <span class="co">#</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    color_discrete_map<span class="op">=</span>colours,  </span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Style tweaks</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>fig_interactive.update_traces(marker<span class="op">=</span><span class="bu">dict</span>(size<span class="op">=</span><span class="dv">3</span>, opacity<span class="op">=</span><span class="fl">0.7</span>))</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>fig_interactive.update_layout(</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"UMAP Projection of Clusters"</span>,</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">"UMAP 1"</span>,</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">"UMAP 2"</span>,</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    legend_title<span class="op">=</span><span class="st">"Cluster"</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="co">#save to html</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>fig_interactive.write_html(<span class="st">"outputs/umap_interactive.html"</span>)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="co"># fig_interactive.update_layout(width=800, height=600)</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>fig_interactive.show(config<span class="op">=</span>{<span class="st">"responsive"</span>: <span class="va">False</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[22]</span><span class="ansi-green-fg">, line 17</span>
<span class="ansi-green-fg">      2</span> colours = {
<span class="ansi-green-fg">      3</span>     <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">A</span><span class="ansi-yellow-fg">"</span>: <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">#8dd3c7</span><span class="ansi-yellow-fg">'</span>,
<span class="ansi-green-fg">      4</span>     <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">B</span><span class="ansi-yellow-fg">"</span>: <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">#ffffb3</span><span class="ansi-yellow-fg">'</span>,
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">     12</span>     <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">J</span><span class="ansi-yellow-fg">"</span>: <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">#ccebc5</span><span class="ansi-yellow-fg">'</span>
<span class="ansi-green-fg">     13</span> }
<span class="ansi-green-fg">     15</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create interactive UMAP scatter plot</span>
<span class="ansi-green-fg">     16</span> fig_interactive = px.scatter(
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">17</span>     <span class="ansi-yellow-bg">umap_results</span>,
<span class="ansi-green-fg">     18</span>     x=<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">UMAP1</span><span class="ansi-yellow-fg">'</span>,
<span class="ansi-green-fg">     19</span>     y=<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">UMAP2</span><span class="ansi-yellow-fg">'</span>,
<span class="ansi-green-fg">     20</span>     color=<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">Cluster</span><span class="ansi-yellow-fg">'</span>,
<span class="ansi-green-fg">     21</span>     category_orders={<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Cluster</span><span class="ansi-yellow-fg">"</span>: <span style="color:rgb(0,135,0)">sorted</span>(umap_results[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Cluster</span><span class="ansi-yellow-fg">"</span>].unique())},  <span style="font-style:italic;color:rgb(95,135,135)">#</span>
<span class="ansi-green-fg">     22</span>     color_discrete_map=colours,  
<span class="ansi-green-fg">     23</span> )
<span class="ansi-green-fg">     25</span> <span style="font-style:italic;color:rgb(95,135,135)"># Style tweaks</span>
<span class="ansi-green-fg">     26</span> fig_interactive.update_traces(marker=<span style="color:rgb(0,135,0)">dict</span>(size=<span class="ansi-green-fg">3</span>, opacity=<span class="ansi-green-fg">0.7</span>))

<span class="ansi-red-fg">NameError</span>: name 'umap_results' is not defined</pre>
</div>
</div>
</div>
<p>The UMAP projection shows there is reasonable separation between the clusters, indicating that the k-means clustering has identified distinct groups in the data. In particular the small cluster in the bottom left which represents the city centre in our case study of Liverpool, is well-defined and separated from other clusters.</p>
<p>There are indications of further structure within clusters, which could be explored further using hierarchical clustering to subdivide clusters into subclusters. More on that in a bit.. for now lets dig into the clusters that we’ve got.</p>
</section>
</section>
<section id="cluster-profiling-naming-and-describing-using-language-models" class="level1 page-columns page-full">
<h1>Cluster Profiling, Naming, and Describing using Language Models</h1>
<p>We can explore the characteristics of each cluster using summary statistics and index scores. This helps us understand each cluster.</p>
<section id="cluster-statistics" class="level2">
<h2 class="anchored" data-anchor-id="cluster-statistics">Cluster Statistics</h2>
<div id="cell-46" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Lot at the characteristics of each cluster</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the data</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>pop_size <span class="op">=</span> pd.read_csv(<span class="st">"input_data/oa_pop_data.csv"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>pop_size <span class="op">=</span> pop_size.set_index(<span class="st">'OA'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#rename column to "population"</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>pop_size <span class="op">=</span> pop_size.rename(columns<span class="op">=</span>{<span class="st">'uk001001'</span>: <span class="st">'population'</span>})</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>pop_size <span class="op">=</span> pop_size[<span class="st">'population'</span>]</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">#basic statistics of each cluster, number (perc of OAs) in each cluster and population</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">#number of OAs in each cluster</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>cluster_counts <span class="op">=</span> supergrouped_variable_df[<span class="st">'cluster'</span>].value_counts().sort_index()</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">#percentage of OAs in each cluster</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>cluster_perc <span class="op">=</span> (cluster_counts <span class="op">/</span> cluster_counts.<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="co">#join pop_size to supergrouped_variable_df on index</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>supergrouped_variable_df_withpop <span class="op">=</span> supergrouped_variable_df.join(pop_size, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co">#pop in each cluster</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>cluster_pop <span class="op">=</span> supergrouped_variable_df_withpop.groupby(<span class="st">'cluster'</span>)[<span class="st">'population'</span>].<span class="bu">sum</span>()</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="co">#percentage of pop in each cluster</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>cluster_pop_perc <span class="op">=</span> (cluster_pop <span class="op">/</span> cluster_pop.<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co">#combine into a dataframe</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>cluster_summary <span class="op">=</span> pd.DataFrame({</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Number of OAs'</span>: cluster_counts,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Percentage of OAs'</span>: cluster_perc,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Population'</span>: cluster_pop,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Percentage of Population'</span>: cluster_pop_perc</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>cluster_summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[23]</span><span class="ansi-green-fg">, line 4</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#Lot at the characteristics of each cluster</span>
<span class="ansi-green-fg">      2</span> 
<span class="ansi-green-fg">      3</span> <span style="font-style:italic;color:rgb(95,135,135)"># Read in the data</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">4</span> pop_size = <span class="ansi-yellow-bg">pd</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_csv</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">input_data/oa_pop_data.csv</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">      5</span> pop_size = pop_size.set_index(<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">OA</span><span class="ansi-yellow-fg">'</span>)
<span class="ansi-green-fg">      6</span> <span style="font-style:italic;color:rgb(95,135,135)">#rename column to "population"</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parsers/readers.py:1026</span>, in <span class="ansi-cyan-fg">read_csv</span><span class="ansi-blue-fg">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, date_format, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options, dtype_backend)</span>
<span class="ansi-green-fg">   1013</span> kwds_defaults = _refine_defaults_read(
<span class="ansi-green-fg">   1014</span>     dialect,
<span class="ansi-green-fg">   1015</span>     delimiter,
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">   1022</span>     dtype_backend=dtype_backend,
<span class="ansi-green-fg">   1023</span> )
<span class="ansi-green-fg">   1024</span> kwds.update(kwds_defaults)
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1026</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_read</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parsers/readers.py:620</span>, in <span class="ansi-cyan-fg">_read</span><span class="ansi-blue-fg">(filepath_or_buffer, kwds)</span>
<span class="ansi-green-fg">    617</span> _validate_names(kwds.get(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">names</span><span class="ansi-yellow-fg">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>))
<span class="ansi-green-fg">    619</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create the parser.</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">620</span> parser = <span class="ansi-yellow-bg">TextFileReader</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    622</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> chunksize <span style="font-weight:bold;color:rgb(175,0,255)">or</span> iterator:
<span class="ansi-green-fg">    623</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> parser

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parsers/readers.py:1620</span>, in <span class="ansi-cyan-fg">TextFileReader.__init__</span><span class="ansi-blue-fg">(self, f, engine, **kwds)</span>
<span class="ansi-green-fg">   1617</span>     <span style="color:rgb(0,135,0)">self</span>.options[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">has_index_names</span><span class="ansi-yellow-fg">"</span>] = kwds[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">has_index_names</span><span class="ansi-yellow-fg">"</span>]
<span class="ansi-green-fg">   1619</span> <span style="color:rgb(0,135,0)">self</span>.handles: IOHandles | <span style="font-weight:bold;color:rgb(0,135,0)">None</span> = <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1620</span> <span style="color:rgb(0,135,0)">self</span>._engine = <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_make_engine</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">engine</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/parsers/readers.py:1880</span>, in <span class="ansi-cyan-fg">TextFileReader._make_engine</span><span class="ansi-blue-fg">(self, f, engine)</span>
<span class="ansi-green-fg">   1878</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">b</span><span class="ansi-yellow-fg">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> mode:
<span class="ansi-green-fg">   1879</span>         mode += <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">b</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1880</span> <span style="color:rgb(0,135,0)">self</span>.handles = <span class="ansi-yellow-bg">get_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">   1881</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1882</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1883</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">encoding</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1884</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">compression</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">compression</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1885</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">memory_map</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">memory_map</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1886</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1887</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">encoding_errors</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">strict</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1888</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">storage_options</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1889</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">   1890</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span>.handles <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">   1891</span> f = <span style="color:rgb(0,135,0)">self</span>.handles.handle

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/projects/GeoDem_CartoWorkshop2025/.venv/lib/python3.12/site-packages/pandas/io/common.py:873</span>, in <span class="ansi-cyan-fg">get_handle</span><span class="ansi-blue-fg">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="ansi-green-fg">    868</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(handle, <span style="color:rgb(0,135,0)">str</span>):
<span class="ansi-green-fg">    869</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Check whether the filename is to be opened in binary mode.</span>
<span class="ansi-green-fg">    870</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode does not support 'encoding' and 'newline'.</span>
<span class="ansi-green-fg">    871</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ioargs.encoding <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">b</span><span class="ansi-yellow-fg">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> ioargs.mode:
<span class="ansi-green-fg">    872</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Encoding</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">873</span>         handle = <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    874</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">handle</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    875</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">ioargs</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    876</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ioargs</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    877</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    878</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">newline</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    879</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    880</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    881</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode</span>
<span class="ansi-green-fg">    882</span>         handle = <span style="color:rgb(0,135,0)">open</span>(handle, ioargs.mode)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'input_data/oa_pop_data.csv'</pre>
</div>
</div>
</div>
</section>
<section id="cluster-profiling" class="level2">
<h2 class="anchored" data-anchor-id="cluster-profiling">Cluster Profiling</h2>
<p>Index scores are a way to summarise how a particular variable behaves within a cluster compared to the overall average. They help identify which characteristics are over- or under-represented in each cluster.</p>
<p>Index scores are calculated as follows:</p>
<p><span class="math display">\[
\text{Index Score} = \left( \frac{\text{Mean of Variable in Cluster}}{\text{Overall Mean of Variable}} \right) \times 100
\]</span></p>
<p>Where:</p>
<ul>
<li><strong>Mean of Variable in Cluster</strong>: the average value of the variable for all areas within the specific cluster.<br>
</li>
<li><strong>Overall Mean of Variable</strong>: the average value of the variable across all areas in the dataset.</li>
</ul>
<p>Here we will look only at variables used in the clustering. It can also be useful to look at variables not used in the clustering or from other data sources to help understand the clusters.</p>
<div id="cell-48" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># map encoding -&gt; human name</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>encoding_to_name <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(var_lookup[<span class="st">"No."</span>], var_lookup[<span class="st">"Variable_Name"</span>]))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> supergrouped_variable_df.columns <span class="cf">if</span> c <span class="op">!=</span> <span class="st">'cluster'</span>]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">#dont average the cluster column</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>cluster_means <span class="op">=</span> supergrouped_variable_df.groupby(<span class="st">'cluster'</span>).mean()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>global_means <span class="op">=</span> supergrouped_variable_df[features].mean()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Calculate percentage difference ---</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>pct_diff <span class="op">=</span> (cluster_means <span class="op">/</span> global_means) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">#drop columns with nan</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>pct_diff <span class="op">=</span> pct_diff.dropna(axis<span class="op">=</span><span class="dv">1</span>, how<span class="op">=</span><span class="st">'any'</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Transpose for easier plotting (rows: encodings, columns: clusters)</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>pct_display_df <span class="op">=</span> pct_diff.T</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># build human names for hover </span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>human_names <span class="op">=</span> pct_display_df.index.<span class="bu">map</span>(<span class="kw">lambda</span> e: encoding_to_name.get(e)).values</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>customdata_pct <span class="op">=</span> np.tile(human_names.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>), (<span class="dv">1</span>, pct_display_df.shape[<span class="dv">1</span>]))</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Heatmap (percentage difference) ---</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>fig_pct <span class="op">=</span> px.imshow(</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    pct_display_df,</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    color_continuous_scale<span class="op">=</span><span class="st">"RdYlGn"</span>,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    origin<span class="op">=</span><span class="st">"lower"</span>,</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    aspect<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="st">"Cluster"</span>, y<span class="op">=</span><span class="st">"Feature (encoding)"</span>, color<span class="op">=</span><span class="st">"</span><span class="sc">% o</span><span class="st">f global mean"</span>),</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    zmin<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    zmax<span class="op">=</span><span class="dv">200</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="co"># attach customdata and set hover</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>fig_pct.data[<span class="dv">0</span>].customdata <span class="op">=</span> customdata_pct</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>fig_pct.update_traces(</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    hovertemplate<span class="op">=</span><span class="st">"Cluster: %</span><span class="sc">{x}</span><span class="st">&lt;br&gt;Encoding: %</span><span class="sc">{y}</span><span class="st">&lt;br&gt;Name: %</span><span class="sc">{customdata}</span><span class="st">&lt;br&gt;</span><span class="sc">% o</span><span class="st">f Global Mean: %</span><span class="sc">{z:.1f}</span><span class="st">%&lt;extra&gt;&lt;/extra&gt;"</span>,</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    zmid<span class="op">=</span><span class="dv">100</span>  <span class="co"># centre colours on 100%</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>fig_pct.update_layout(</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Cluster Profiles (</span><span class="sc">% o</span><span class="st">f Global Mean)"</span>,</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">"Cluster"</span>,</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">"Feature (encoding)"</span>,</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">800</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>fig_pct.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[24]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># map encoding -&gt; human name</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> encoding_to_name = <span style="color:rgb(0,135,0)">dict</span>(<span style="color:rgb(0,135,0)">zip</span>(<span class="ansi-yellow-bg">var_lookup</span>[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">No.</span><span class="ansi-yellow-fg">"</span>], var_lookup[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Variable_Name</span><span class="ansi-yellow-fg">"</span>]))
<span class="ansi-green-fg">      4</span> features = [c <span style="font-weight:bold;color:rgb(0,135,0)">for</span> c <span style="font-weight:bold;color:rgb(175,0,255)">in</span> supergrouped_variable_df.columns <span style="font-weight:bold;color:rgb(0,135,0)">if</span> c != <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">cluster</span><span class="ansi-yellow-fg">'</span>]
<span class="ansi-green-fg">      5</span> <span style="font-style:italic;color:rgb(95,135,135)">#dont average the cluster column</span>

<span class="ansi-red-fg">NameError</span>: name 'var_lookup' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="llm-cluster-naming-and-description" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="llm-cluster-naming-and-description">LLM Cluster Naming (and description)</h2>
<p>To create a useful geodemographic classification, we need to assign meaningful names and descriptions to each cluster. This helps in interpreting the clusters and communicating their characteristics effectively.<br>
Traditionally, this is done manually by examining the statistical profiles of each cluster and using domain knowledge to assign names. It is a time consuming process. However, we can leverage <strong>Large Language Models (LLMs)</strong> to assist in this process.</p>
<p>We have demonstrated that LLMs can be used to generate initial name and description suggestions based on the statistical profiles of each cluster <span class="citation" data-cites="llmpaper">(<a href="#ref-llmpaper" role="doc-biblioref">Alex D. Singleton and Spielman 2024</a>)</span>. We can use LLMs to generate initial name and description suggestions based on the statistical profiles of each cluster. Here only the variables used in the clustering are included. It can also be useful to include other variables or external data to provide more context for the LLM.</p>
<div class="no-row-height column-margin column-container"><div id="ref-llmpaper" class="csl-entry" role="listitem">
Singleton, Alex D., and Seth Spielman. 2024. <span>“Segmentation Using Large Language Models: A New Typology of American Neighborhoods.”</span> <em>EPJ Data Science</em> 13 (34). <a href="https://doi.org/10.1140/epjds/s13688-024-00466-1">https://doi.org/10.1140/epjds/s13688-024-00466-1</a>.
</div></div><section id="using-the-openai-api" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="using-the-openai-api">Using the OpenAI API</h3>
<p>Below I use the OpenAI API, if you have an API key insert it in an .env file<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> as OPENAI_API_KEY=“sk….sA”</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;.env files are files that contain environment variables, they can be created as a plain text file (named .env) in the root directory. These files often contain private information so should not be commited to git</p></div></div><p><strong>If you do have an API key skip the next cell and go to the cell where we will use a browser prompt to get the cluster names and descriptions.</strong></p>
<div id="cell-50" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>load_dotenv()  <span class="co"># this loads variables from .env into environment</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#get your OpenAI API key from environment variable</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>openai_api_key <span class="op">=</span> os.getenv(<span class="st">"OPENAI_API_KEY"</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> openai_api_key:</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Please set the OPENAI_API_KEY environment variable."</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> openai.OpenAI(api_key<span class="op">=</span>openai_api_key)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># JSON Schema for output</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>cluster_schema <span class="op">=</span> {</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span>: <span class="st">"object"</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"properties"</span>: {</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>},</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"description"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>},</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"required"</span>: [<span class="st">"name"</span>, <span class="st">"description"</span>],</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"additionalProperties"</span>: <span class="va">False</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>system_prompt <span class="op">=</span> <span class="st">"""You are a geodemographic analyst. </span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="st">Your task is to produce commercial-style geodemographic cluster pen portraits </span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="st">and cluster names."""</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>user_prompt <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="st">A geodemographics company is trying to explain the characteristics</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="st">of several neighborhoods to a new customer. They present data comparing each</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="st">neighborhood to the region average. A score of 100 means the neighborhood</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="st">is equivalent to the regional average, 150 means one and a half times,</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="st">200 means twice, 50 means half, and 300 means three times the regional average.</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="st">Write a pen portrait for the neighborhood based on the data provided.</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="st">The description of each neighborhood should focus on characteristics with</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="st">scores above 120 or below 80. Write in the third person, no more than 500 words. </span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="st">Do not mention the specific scores. </span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a><span class="st">Instead, describe patterns relative to the regional average (above/below). </span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a><span class="st">In the style of a commercial geodemographic classification,</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a><span class="st">create a cluster name that summarises the pen portrait. </span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a><span class="st">The name should capture as many different characteristics as possible</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a><span class="st">and be no more than 3 words.</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through clusters</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>cluster_summaries <span class="op">=</span> {}</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cluster <span class="kw">in</span> pct_diff.index:</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>    cluster_pct <span class="op">=</span> pct_diff.loc[cluster]</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>    cluster_data <span class="op">=</span> {</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cluster"</span>: cluster,</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">"data"</span>: {</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>            encoding_to_name.get(feature): <span class="bu">round</span>(value, <span class="dv">1</span>)</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> feature, value <span class="kw">in</span> cluster_pct.items()</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> client.responses.create(</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span><span class="st">"gpt-5-mini"</span>,</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">input</span><span class="op">=</span>[</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_prompt.strip()},</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: user_prompt.strip()},</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: json.dumps(cluster_data)},</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span>{</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">"format"</span>: {</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: <span class="st">"json_schema"</span>,</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>                <span class="st">"name"</span>: <span class="st">"cluster_summary"</span>,</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>                <span class="st">"schema"</span>: cluster_schema,</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>                <span class="st">"strict"</span>: <span class="va">True</span>,</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>    cluster_summary <span class="op">=</span> json.loads(response.output_text)</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># store under your cluster ID</span></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>    cluster_summaries[cluster] <span class="op">=</span> cluster_summary</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>cluster_summaries</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prompt-for-browser-based-llm" class="level3">
<h3 class="anchored" data-anchor-id="prompt-for-browser-based-llm">Prompt for Browser Based LLM</h3>
<p>The follow code cell generates a prompt for to be used in an LLM of your choice. Try it in your browser based LLM of choice (e.g.&nbsp;chatGPT, Claude, Gemini, etc)</p>
<p>The prompt should insure that the LLM produses the output in the correct format but this cannot be guaranteed.</p>
<div id="cell-52" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#print the prompt to copy and paste into a LLM to generate cluster descriptions</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>prompt_intial <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="st">A geodemographics company is trying to explain the characteristics of several neighbourhoods to a new customer. </span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="st">They present data comparing each neighbourhood to the region average. </span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="st">A score of 100 means the neighbourhood is equivalent to the national average, </span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="st">a score of 150 means the neighbourhood is one and a half times the national average, </span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="st">a score of 200 means the neighbourhood is twice the national average, </span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="st">a score of 50 means the neighbourhood is half of the region average, </span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="st">a score of 300 means the neighbourhood is three times the region average. </span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="st">Each neighbourhood has the following characteristics, described in #DATA# below. </span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="st">Data are presented for each characteristic followed by a colon, and then a score. </span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="st">The description of each neighbourhood should focus on characteristics that have scores which are greater than 120 or less than 80.</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="st">Write a separate description for each cluster (Cluster A, Cluster B, Cluster C, Cluster D, etc. </span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="st">Each description should be written in the third person, in no more than 500 words. Do not mention the specific scores from the #DATA#. </span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="st">Instead, use descriptive words to illustrate rates that are above or below the regional average.</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="st">Make comparisons to the regional average, do not talk in absolute terms.</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>prompt_data <span class="op">=</span><span class="st">""</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co"># print the index scores for each cluster in this format:</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cluster <span class="kw">in</span> pct_diff.index:</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    prompt_data <span class="op">+=</span> <span class="ss">f"</span><span class="ch">\n</span><span class="ss">#DATA# cluster_key: </span><span class="sc">{</span>cluster<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    cluster_pct <span class="op">=</span> pct_diff.loc[cluster]</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, value <span class="kw">in</span> cluster_pct.items():</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        feature_name <span class="op">=</span> encoding_to_name.get(feature)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        prompt_data <span class="op">+=</span> <span class="ss">f"</span><span class="sc">{</span>feature_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">:.1f}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>prompt_struc <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="st">In the style of a commercial geodemographic classification; create a cluster name </span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="st">that would summarise the created geodemographic pen portraits. The names should capture as many </span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="st">different characteristics contained within the description as possible. </span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="st">The cluster name should be no more than 3 words.</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="st">Return your response in JSON format with the structure:</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="st">{"cluster_key_1": {"name": "", "description": ""},</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="st">"cluster_key_2": {"name": "", "description": ""},...}"""</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>full_prompt <span class="op">=</span> prompt_intial <span class="op">+</span> prompt_data <span class="op">+</span> prompt_struc</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(full_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[25]</span><span class="ansi-green-fg">, line 24</span>
<span class="ansi-green-fg">     21</span> prompt_data =<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">     22</span> <span style="font-style:italic;color:rgb(95,135,135)"># print the index scores for each cluster in this format:</span>
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">24</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> cluster <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span class="ansi-yellow-bg">pct_diff</span>.index:
<span class="ansi-green-fg">     25</span>     prompt_data += <span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span class="ansi-yellow-fg">#DATA# cluster_key: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>cluster<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">     26</span>     cluster_pct = pct_diff.loc[cluster]

<span class="ansi-red-fg">NameError</span>: name 'pct_diff' is not defined</pre>
</div>
</div>
</div>
<p>Copy the result in here;</p>
<div id="cell-54" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>cluster_summaries <span class="op">=</span> {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"A"</span>: {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Established Professional Residents"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"description"</span>: <span class="st">"This neighbourhood is characterised by an older demographic profile, with notably higher proportions of residents aged sixty-five and over, particularly those aged eighty-five and above who are represented at considerably elevated levels compared to the regional average. The area has a markedly high concentration of residents living in communal establishments, appearing at more than twice the regional rate. Housing stock is distinctively skewed towards flats, maisonettes, and apartments, which feature at substantially elevated levels, while detached properties also appear somewhat above the regional norm. The residential population shows a strong presence of one-person households, appearing at moderately elevated levels. The neighbourhood demonstrates an established, relatively settled character, with residents predominantly UK-born and overwhelmingly from a single ethnic background. The Black population is notably underrepresented, appearing at substantially lower levels than the regional average, while residents who cannot speak English well or at all are also significantly below regional norms. The area exhibits a professional character, with managers, directors, senior officials, and professional occupations represented at moderately elevated levels. Educational attainment leans towards higher qualifications, with Level 4 qualifications and above appearing at notably higher rates. Residents are more likely to be married or in registered civil partnerships, and somewhat more likely to be separated or divorced than the regional average. The neighbourhood shows lower proportions of families with dependent children and younger age groups, particularly those under five, who appear at moderately reduced levels. Despite the professional occupational profile, full-time students are somewhat underrepresented, and unemployment appears at lower levels than the region. The area has moderately elevated rates of private rental accommodation alongside ownership, suggesting a mixed tenure profile that accommodates both established homeowners and professional renters."</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"B"</span>: {</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Multicultural Urban Families"</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"description"</span>: <span class="st">"This neighbourhood stands out for its remarkable ethnic diversity, with substantially elevated representation across multiple minority ethnic groups. Pakistani, Black, Bangladeshi, and Other Asian populations all appear at considerably higher levels than the regional average, with some groups represented at nearly three times the regional rate. Chinese and Indian populations are also present at notably elevated levels, while the White population is moderately below the regional average. This diversity is reflected in the country of birth data, with residents born in Africa appearing at more than twice the regional rate, and those from both EU and non-EU European countries substantially overrepresented. The neighbourhood faces significant linguistic challenges, with residents who cannot speak English well or at all appearing at nearly three times the regional rate. The area has a younger demographic profile, with children under five represented at moderately elevated levels, while older residents, particularly those aged eighty-five and over, appear at substantially reduced rates. The housing landscape is dominated by terraced houses and flats, both appearing at considerably elevated levels, while detached and semi-detached properties are somewhat underrepresented. Social rented accommodation features prominently at substantially higher rates, alongside moderately elevated private rental levels, while ownership rates fall notably below the regional average. Vehicle ownership is considerably lower, with households having two or more cars appearing at substantially reduced levels. The occupational structure skews towards elementary occupations, which appear at moderately elevated rates, while managers, directors, and senior officials are somewhat underrepresented. Unemployment appears at considerably higher levels than the regional average. The neighbourhood shows elevated proportions of part-time workers and full-time students. Despite the diverse population, families with dependent children appear at levels close to the regional average, while one-person households are moderately elevated. Religious adherence is notable, with followers of non-Christian religions appearing at moderately elevated levels."</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"C"</span>: {</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Working Family Terraces"</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"description"</span>: <span class="st">"This neighbourhood presents a working-class character with a predominantly UK-born, White population that closely mirrors regional averages. The area is notably less diverse than the region, with most minority ethnic groups substantially underrepresented, particularly Pakistani populations who appear at less than half the regional rate. Black, Bangladeshi, Chinese, and Indian populations are all present at considerably reduced levels. Residents born in Africa, non-EU Europe, and EU countries all appear at notably lower rates than the regional average. The demographic profile shows a family-oriented character, with children under five and those aged five to fourteen both appearing at moderately elevated levels, while residents aged eighty-five and over are present at somewhat reduced rates. Families with dependent children feature at moderately higher levels than the region. The housing stock is heavily weighted towards terraced properties, which appear at substantially elevated rates, while detached houses and flats are both considerably underrepresented. Social rented accommodation is present at considerably elevated levels, while ownership rates remain close to regional norms. The communal establishment population is dramatically underrepresented, appearing at nearly half the regional rate. The neighbourhood's occupational profile reveals a working-class character, with elementary occupations, process plant and machine operatives, sales and customer service occupations, and caring service occupations all appearing at moderately elevated levels. Conversely, managers, directors, senior officials, and professional occupations are both somewhat underrepresented. Educational attainment trends lower, with Level 4 qualifications considerably below regional rates, while Level 1-2 qualifications appear at moderately elevated levels. Unemployment is present at moderately higher rates than the regional average. The area shows relative residential stability, with most residents living at the same address as one year prior, and households predominantly comprising members from the same ethnic group."</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"D"</span>: {</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Student Cosmopolitan Flats"</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"description"</span>: <span class="st">"This neighbourhood exhibits a distinctly transient, young adult character, overwhelmingly dominated by residents living in communal establishments at more than five times the regional rate. The area shows a dramatic absence of children and older residents, with those aged under five appearing at less than two-thirds the regional rate, those aged five to fourteen at less than half, and those aged eighty-five and over at roughly one-quarter of regional levels. Middle-aged residents are also considerably underrepresented. The population is remarkably diverse and internationally oriented, with residents born outside the UK substantially overrepresented. Those born in non-EU European countries appear at more than three times the regional rate, while African and EU-born residents are also present at considerably elevated levels. UK-born residents are notably underrepresented. This international character is reflected in exceptional ethnic diversity, with Pakistani, Indian, Chinese, Black, Bangladeshi, Other Asian, and Mixed ethnic group populations all appearing at substantially elevated levels, many at roughly three times the regional rate. The White population is moderately below regional averages. Language barriers are significant, with residents who cannot speak English well or at all appearing at roughly twice the regional rate. Full-time students are present at substantially elevated rates, nearly one and a half times the regional average, explaining much of the neighbourhood's character. The housing stock is dominated by flats, maisonettes, and apartments at more than twice the regional rate, while traditional houses—detached, semi-detached, and terraced—are all dramatically underrepresented. Private rental accommodation is substantially elevated, while ownership rates are notably below regional levels. The area shows high residential turnover, with residents far less likely to be living at the same address as one year prior. Educational qualifications trend higher, with Level 3 and particularly Level 4 qualifications above regional rates, while lower-level qualifications are substantially underrepresented. Professional occupations appear at moderately elevated levels, while skilled trades and process plant operatives are considerably below regional averages. Never-married individuals are substantially overrepresented, while married couples and families with dependent children appear at considerably reduced rates."</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"E"</span>: {</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Suburban Family Homeowners"</span>,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"description"</span>: <span class="st">"This neighbourhood represents an affluent, predominantly White British suburban character. The population is overwhelmingly UK-born, with residents from EU countries, non-EU Europe, and Africa all appearing at substantially reduced levels compared to the regional average. Ethnic diversity is notably low, with Black populations present at less than half the regional rate, and Pakistani, Bangladeshi, Other Asian, and Mixed ethnic group populations all considerably underrepresented. Language barriers are virtually absent, with residents who cannot speak English well or at all appearing at roughly one-third of the regional rate. The area exhibits strong ethnic homogeneity, with households where all members share the same ethnic group appearing at moderately elevated levels. The demographic profile skews slightly older, with residents aged sixty-five to eighty-four and those aged eighty-five and over both appearing at moderately elevated rates. The housing landscape is characterised by owner-occupation at moderately elevated levels, with detached houses substantially overrepresented and semi-detached properties also appearing above regional averages. Conversely, terraced houses appear at less than half the regional rate, while flats are dramatically underrepresented at roughly one-third of regional levels. Social rented accommodation is substantially below regional averages, as is private rental accommodation. The area demonstrates affluence through vehicle ownership, with households possessing two or more cars appearing at moderately elevated rates. The occupational structure reflects professional and managerial employment, with managers, directors, senior officials, professional occupations, and associate professional and technical occupations all appearing at moderately elevated levels. Elementary occupations are somewhat underrepresented. Educational attainment is strong, with Level 4 qualifications and above appearing at moderately elevated rates. Employment rates are favourable, with unemployment substantially below regional levels at roughly three-quarters of the regional rate. The neighbourhood shows a family-oriented character, with married couples moderately overrepresented and never-married individuals somewhat underrepresented. Families with no children appear at moderately elevated levels. One-person households and communal establishment residents are both substantially below regional averages, reinforcing the family-oriented suburban character."</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>cluster_descriptions_df <span class="op">=</span> pd.DataFrame.from_dict(cluster_summaries, orient<span class="op">=</span><span class="st">'index'</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co">#pretty print the descriptions (break lines for readability)</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cluster, row <span class="kw">in</span> cluster_descriptions_df.iterrows():</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cluster </span><span class="sc">{</span>cluster<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>row[<span class="st">'name'</span>]<span class="sc">}</span><span class="ss">:</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    description <span class="op">=</span> row[<span class="st">'description'</span>]</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#break into lines of max 80 characters</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> textwrap</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    wrapped_description <span class="op">=</span> textwrap.fill(description, width<span class="op">=</span><span class="dv">70</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(wrapped_description, <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cluster A - Established Professional Residents:

This neighbourhood is characterised by an older demographic profile,
with notably higher proportions of residents aged sixty-five and over,
particularly those aged eighty-five and above who are represented at
considerably elevated levels compared to the regional average. The
area has a markedly high concentration of residents living in communal
establishments, appearing at more than twice the regional rate.
Housing stock is distinctively skewed towards flats, maisonettes, and
apartments, which feature at substantially elevated levels, while
detached properties also appear somewhat above the regional norm. The
residential population shows a strong presence of one-person
households, appearing at moderately elevated levels. The neighbourhood
demonstrates an established, relatively settled character, with
residents predominantly UK-born and overwhelmingly from a single
ethnic background. The Black population is notably underrepresented,
appearing at substantially lower levels than the regional average,
while residents who cannot speak English well or at all are also
significantly below regional norms. The area exhibits a professional
character, with managers, directors, senior officials, and
professional occupations represented at moderately elevated levels.
Educational attainment leans towards higher qualifications, with Level
4 qualifications and above appearing at notably higher rates.
Residents are more likely to be married or in registered civil
partnerships, and somewhat more likely to be separated or divorced
than the regional average. The neighbourhood shows lower proportions
of families with dependent children and younger age groups,
particularly those under five, who appear at moderately reduced
levels. Despite the professional occupational profile, full-time
students are somewhat underrepresented, and unemployment appears at
lower levels than the region. The area has moderately elevated rates
of private rental accommodation alongside ownership, suggesting a
mixed tenure profile that accommodates both established homeowners and
professional renters. 


Cluster B - Multicultural Urban Families:

This neighbourhood stands out for its remarkable ethnic diversity,
with substantially elevated representation across multiple minority
ethnic groups. Pakistani, Black, Bangladeshi, and Other Asian
populations all appear at considerably higher levels than the regional
average, with some groups represented at nearly three times the
regional rate. Chinese and Indian populations are also present at
notably elevated levels, while the White population is moderately
below the regional average. This diversity is reflected in the country
of birth data, with residents born in Africa appearing at more than
twice the regional rate, and those from both EU and non-EU European
countries substantially overrepresented. The neighbourhood faces
significant linguistic challenges, with residents who cannot speak
English well or at all appearing at nearly three times the regional
rate. The area has a younger demographic profile, with children under
five represented at moderately elevated levels, while older residents,
particularly those aged eighty-five and over, appear at substantially
reduced rates. The housing landscape is dominated by terraced houses
and flats, both appearing at considerably elevated levels, while
detached and semi-detached properties are somewhat underrepresented.
Social rented accommodation features prominently at substantially
higher rates, alongside moderately elevated private rental levels,
while ownership rates fall notably below the regional average. Vehicle
ownership is considerably lower, with households having two or more
cars appearing at substantially reduced levels. The occupational
structure skews towards elementary occupations, which appear at
moderately elevated rates, while managers, directors, and senior
officials are somewhat underrepresented. Unemployment appears at
considerably higher levels than the regional average. The
neighbourhood shows elevated proportions of part-time workers and
full-time students. Despite the diverse population, families with
dependent children appear at levels close to the regional average,
while one-person households are moderately elevated. Religious
adherence is notable, with followers of non-Christian religions
appearing at moderately elevated levels. 


Cluster C - Working Family Terraces:

This neighbourhood presents a working-class character with a
predominantly UK-born, White population that closely mirrors regional
averages. The area is notably less diverse than the region, with most
minority ethnic groups substantially underrepresented, particularly
Pakistani populations who appear at less than half the regional rate.
Black, Bangladeshi, Chinese, and Indian populations are all present at
considerably reduced levels. Residents born in Africa, non-EU Europe,
and EU countries all appear at notably lower rates than the regional
average. The demographic profile shows a family-oriented character,
with children under five and those aged five to fourteen both
appearing at moderately elevated levels, while residents aged eighty-
five and over are present at somewhat reduced rates. Families with
dependent children feature at moderately higher levels than the
region. The housing stock is heavily weighted towards terraced
properties, which appear at substantially elevated rates, while
detached houses and flats are both considerably underrepresented.
Social rented accommodation is present at considerably elevated
levels, while ownership rates remain close to regional norms. The
communal establishment population is dramatically underrepresented,
appearing at nearly half the regional rate. The neighbourhood's
occupational profile reveals a working-class character, with
elementary occupations, process plant and machine operatives, sales
and customer service occupations, and caring service occupations all
appearing at moderately elevated levels. Conversely, managers,
directors, senior officials, and professional occupations are both
somewhat underrepresented. Educational attainment trends lower, with
Level 4 qualifications considerably below regional rates, while Level
1-2 qualifications appear at moderately elevated levels. Unemployment
is present at moderately higher rates than the regional average. The
area shows relative residential stability, with most residents living
at the same address as one year prior, and households predominantly
comprising members from the same ethnic group. 


Cluster D - Student Cosmopolitan Flats:

This neighbourhood exhibits a distinctly transient, young adult
character, overwhelmingly dominated by residents living in communal
establishments at more than five times the regional rate. The area
shows a dramatic absence of children and older residents, with those
aged under five appearing at less than two-thirds the regional rate,
those aged five to fourteen at less than half, and those aged eighty-
five and over at roughly one-quarter of regional levels. Middle-aged
residents are also considerably underrepresented. The population is
remarkably diverse and internationally oriented, with residents born
outside the UK substantially overrepresented. Those born in non-EU
European countries appear at more than three times the regional rate,
while African and EU-born residents are also present at considerably
elevated levels. UK-born residents are notably underrepresented. This
international character is reflected in exceptional ethnic diversity,
with Pakistani, Indian, Chinese, Black, Bangladeshi, Other Asian, and
Mixed ethnic group populations all appearing at substantially elevated
levels, many at roughly three times the regional rate. The White
population is moderately below regional averages. Language barriers
are significant, with residents who cannot speak English well or at
all appearing at roughly twice the regional rate. Full-time students
are present at substantially elevated rates, nearly one and a half
times the regional average, explaining much of the neighbourhood's
character. The housing stock is dominated by flats, maisonettes, and
apartments at more than twice the regional rate, while traditional
houses—detached, semi-detached, and terraced—are all dramatically
underrepresented. Private rental accommodation is substantially
elevated, while ownership rates are notably below regional levels. The
area shows high residential turnover, with residents far less likely
to be living at the same address as one year prior. Educational
qualifications trend higher, with Level 3 and particularly Level 4
qualifications above regional rates, while lower-level qualifications
are substantially underrepresented. Professional occupations appear at
moderately elevated levels, while skilled trades and process plant
operatives are considerably below regional averages. Never-married
individuals are substantially overrepresented, while married couples
and families with dependent children appear at considerably reduced
rates. 


Cluster E - Suburban Family Homeowners:

This neighbourhood represents an affluent, predominantly White British
suburban character. The population is overwhelmingly UK-born, with
residents from EU countries, non-EU Europe, and Africa all appearing
at substantially reduced levels compared to the regional average.
Ethnic diversity is notably low, with Black populations present at
less than half the regional rate, and Pakistani, Bangladeshi, Other
Asian, and Mixed ethnic group populations all considerably
underrepresented. Language barriers are virtually absent, with
residents who cannot speak English well or at all appearing at roughly
one-third of the regional rate. The area exhibits strong ethnic
homogeneity, with households where all members share the same ethnic
group appearing at moderately elevated levels. The demographic profile
skews slightly older, with residents aged sixty-five to eighty-four
and those aged eighty-five and over both appearing at moderately
elevated rates. The housing landscape is characterised by owner-
occupation at moderately elevated levels, with detached houses
substantially overrepresented and semi-detached properties also
appearing above regional averages. Conversely, terraced houses appear
at less than half the regional rate, while flats are dramatically
underrepresented at roughly one-third of regional levels. Social
rented accommodation is substantially below regional averages, as is
private rental accommodation. The area demonstrates affluence through
vehicle ownership, with households possessing two or more cars
appearing at moderately elevated rates. The occupational structure
reflects professional and managerial employment, with managers,
directors, senior officials, professional occupations, and associate
professional and technical occupations all appearing at moderately
elevated levels. Elementary occupations are somewhat underrepresented.
Educational attainment is strong, with Level 4 qualifications and
above appearing at moderately elevated rates. Employment rates are
favourable, with unemployment substantially below regional levels at
roughly three-quarters of the regional rate. The neighbourhood shows a
family-oriented character, with married couples moderately
overrepresented and never-married individuals somewhat
underrepresented. Families with no children appear at moderately
elevated levels. One-person households and communal establishment
residents are both substantially below regional averages, reinforcing
the family-oriented suburban character. 

</code></pre>
</div>
</div>
<p>While the LLM generated names and descriptions are a very useful starting point, it is important to review the outputs carefully both for accuracy, and that they make sense in the context of your specific region and purpose. Any use of LLMs in a production context would need to invove a human in the loop to review the outputs and a ground truthing exercise to ensure the outputs are valid.</p>
<div id="cell-56" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>cluster_descriptions_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">A</td>
<td>Established Professional Residents</td>
<td>This neighbourhood is characterised by an olde...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">B</td>
<td>Multicultural Urban Families</td>
<td>This neighbourhood stands out for its remarkab...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">C</td>
<td>Working Family Terraces</td>
<td>This neighbourhood presents a working-class ch...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">D</td>
<td>Student Cosmopolitan Flats</td>
<td>This neighbourhood exhibits a distinctly trans...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">E</td>
<td>Suburban Family Homeowners</td>
<td>This neighbourhood represents an affluent, pre...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="save-results" class="level2">
<h2 class="anchored" data-anchor-id="save-results">Save Results</h2>
<p>Lets save the results to file for use in GIS software or to format for sharing.</p>
<div id="cell-59" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cluster_descriptions_df.to_csv(<span class="st">"outputs/cluster_descriptions.csv"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> oas_region.merge(supergrouped_variable_df, left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">#save to gpkg</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>gdf.to_file(<span class="st">"outputs/clustered_geodataframe.gpkg"</span>, layer<span class="op">=</span><span class="st">"clusters"</span>, driver<span class="op">=</span><span class="st">"GPKG"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[29]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> cluster_descriptions_df.to_csv(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">outputs/cluster_descriptions.csv</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> gdf = <span class="ansi-yellow-bg">oas_region</span>.merge(supergrouped_variable_df, left_index=<span style="font-weight:bold;color:rgb(0,135,0)">True</span>, right_index=<span style="font-weight:bold;color:rgb(0,135,0)">True</span>, how=<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">left</span><span class="ansi-yellow-fg">'</span>)
<span class="ansi-green-fg">      3</span> <span style="font-style:italic;color:rgb(95,135,135)">#save to gpkg</span>
<span class="ansi-green-fg">      4</span> gdf.to_file(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">outputs/clustered_geodataframe.gpkg</span><span class="ansi-yellow-fg">"</span>, layer=<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">clusters</span><span class="ansi-yellow-fg">"</span>, driver=<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">GPKG</span><span class="ansi-yellow-fg">"</span>)

<span class="ansi-red-fg">NameError</span>: name 'oas_region' is not defined</pre>
</div>
</div>
</div>
</section>
</section>
<section id="hierarchical-subclustering" class="level1">
<h1>Hierarchical Subclustering</h1>
<p>We often want to perform a finer level of clustering to capture more detailed patterns in the data. For OAC the top level “supergroup” clusters are split further into groups and subgroups by applying the above process iteratively. This process is referred to as top down clustering. This has the advantage of allowing more clusters to be created without needing to consider all clusters at once. It also allows for more interpretable clusters as the subclusters are nested within the broader supergroup clusters.</p>
<section id="selecting-the-number-of-subclusters" class="level2">
<h2 class="anchored" data-anchor-id="selecting-the-number-of-subclusters">Selecting the Number of Subclusters</h2>
<p>We can use clustergrams again to select the number of subclusters for each supergroup. We create clustergrams for each supergroup and select the number of subclusters based on the same principles as before.</p>
<div id="cell-61" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_subcluster_clustergrams(output_df, num_clusters, n_init<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate and save clustergrams for each supercluster.</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This function loops through the existing clusters and creates a clustergram </span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">    for each</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">    output_df (pd.DataFrame): DataFrame containing cluster assignments.</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">    num_clusters (int): The total number of clusters to iterate over.</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">    n_init (int, optional): Number of times K-means runs with different centroid seeds.</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">                            Defaults to 1 for quick testing.</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    save_dir <span class="op">=</span> <span class="st">"outputs/plots"</span> <span class="co">#directory to save the clustergrams</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    os.makedirs(save_dir, exist_ok<span class="op">=</span><span class="va">True</span>)  <span class="co"># Ensure save directory exists</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    cluster_labels <span class="op">=</span> np.sort(output_df[<span class="st">"cluster"</span>].unique())</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(cluster_labels)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cluster_label <span class="kw">in</span> cluster_labels:</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select rows corresponding to the current cluster, dropping the 'cluster' column</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>        cluster_df <span class="op">=</span> output_df.query(<span class="st">"cluster == @cluster_label"</span>).drop(columns<span class="op">=</span><span class="st">'cluster'</span>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Cluster: </span><span class="sc">{</span>cluster_label<span class="sc">,</span>cluster_summaries[cluster_label][<span class="st">'name'</span>]<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span><span class="bu">len</span>(cluster_df)<span class="sc">}</span><span class="ss"> geographies in cluster"</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cluster_df.empty:</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Skipping cluster </span><span class="sc">{</span>cluster_label<span class="sc">}</span><span class="ss"> as it has no data."</span>)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define save location</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        save_loc <span class="op">=</span> os.path.join(save_dir, <span class="ss">f"subcluster_clustergram_cluster</span><span class="sc">{</span>cluster_label<span class="sc">}</span><span class="ss">.png"</span>)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Saving clustergram to </span><span class="sc">{</span>save_loc<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate clustergram</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        cgram_sub <span class="op">=</span> Clustergram(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>), n_init<span class="op">=</span>n_init, random_state<span class="op">=</span>random_seed,verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        cgram_sub.fit(cluster_df)  <span class="co"># Fit model to data</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        cgram_sub.plot()  <span class="co"># Generate plot</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>        plt.suptitle(<span class="ss">f"Clustergram for Cluster </span><span class="sc">{</span>cluster_label<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>cluster_summaries[cluster_label][<span class="st">'name'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>        plt.savefig(save_loc)  <span class="co"># Save figure</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        plt.show()  <span class="co"># Display plot</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>create_subcluster_clustergrams(supergrouped_variable_df, num_clusters, n_init<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[30]</span><span class="ansi-green-fg">, line 40</span>
<span class="ansi-green-fg">     37</span>         plt.show()  <span style="font-style:italic;color:rgb(95,135,135)"># Display plot</span>
<span class="ansi-green-fg">     39</span> <span style="font-style:italic;color:rgb(95,135,135)"># Example usage</span>
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">40</span> create_subcluster_clustergrams(<span class="ansi-yellow-bg">supergrouped_variable_df</span>, num_clusters, n_init=<span class="ansi-green-fg">50</span>)

<span class="ansi-red-fg">NameError</span>: name 'supergrouped_variable_df' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="run-the-subclustering" class="level2">
<h2 class="anchored" data-anchor-id="run-the-subclustering">Run the subclustering</h2>
<p>We can now select the number of subclusters to split each of the supergroups into using the clustergrams above. The length of the list must match num_clusters (the number of supergroups).</p>
<div id="cell-63" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>subcluster_nums <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-64" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_subclustering(input_df: pd.DataFrame, subcluster_nums: <span class="bu">list</span>, num_clusters: <span class="bu">int</span>, n_init: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Runs subclustering for each supergroup using KMeans and returns a modified DataFrame with subcluster labels.</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - output_df (pd.DataFrame): The original DataFrame containing data and cluster assignments.</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">    - subcluster_nums (list): A list specifying the number of subclusters to split each supergroup into.</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - num_clusters (int): The total number of supergroups.</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - n_init (int, optional): The number of times KMeans will be initialized. Defaults to 1.</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - pd.DataFrame: A new the output dataFrame with an added 'subcluster' column.</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    cluster_labels <span class="op">=</span> np.sort(input_df[<span class="st">"cluster"</span>].unique())</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cluster labels found: </span><span class="sc">{</span>cluster_labels<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(subcluster_nums) <span class="op">!=</span> <span class="bu">len</span>(cluster_labels):</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Length of subcluster_nums (</span><span class="sc">{</span><span class="bu">len</span>(subcluster_nums)<span class="sc">}</span><span class="ss">) does not match num_clusters (</span><span class="sc">{</span><span class="bu">len</span>(cluster_labels)<span class="sc">}</span><span class="ss">)."</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Work on a copy of the DataFrame to prevent unintended modifications</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> input_df.copy()</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cluster, num_subclusters <span class="kw">in</span> <span class="bu">zip</span>(cluster_labels, subcluster_nums):</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Clustering supergroup </span><span class="sc">{</span>cluster<span class="sc">,</span>cluster_summaries[cluster][<span class="st">'name'</span>]<span class="sc">}</span><span class="ss"> into </span><span class="sc">{</span>num_subclusters<span class="sc">}</span><span class="ss"> subclusters."</span>)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select rows corresponding to the current cluster, drop the cluster column before clustering</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>        cluster_df <span class="op">=</span> input_df.query(<span class="st">"cluster == @cluster"</span>).drop(columns<span class="op">=</span><span class="st">'cluster'</span>).copy()</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run KMeans clustering for the selected supergroup</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        subcluster_output_df <span class="op">=</span> cluster_df.copy()</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>        kmeans_sub <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>num_subclusters, init<span class="op">=</span><span class="st">"random"</span>, random_state<span class="op">=</span>random_seed, n_init<span class="op">=</span>n_init)</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>        subcluster_output_df[<span class="st">'cluster'</span>] <span class="op">=</span> kmeans_sub.fit_predict(cluster_df)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine names</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>        subcluster_output_df[<span class="st">'subcluster'</span>] <span class="op">=</span> [<span class="bu">str</span>(cluster) <span class="op">+</span> <span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> subcluster_output_df[<span class="st">'cluster'</span>]]</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update the modified DataFrame with subclustering results</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        df.loc[cluster_df.index, <span class="st">'subcluster'</span>] <span class="op">=</span> subcluster_output_df[<span class="st">'subcluster'</span>]</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the final output</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    df[[<span class="st">"cluster"</span>,<span class="st">"subcluster"</span>]].to_csv(<span class="st">"outputs/subgroups_clusteroutput.csv"</span>)</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Final output saved to outputs/subgroups_clusteroutput.csv"</span>)</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df  <span class="co"># Return the modified DataFrame with clusters and subclusters</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>subgrouped_variable_df <span class="op">=</span> run_subclustering(supergrouped_variable_df, subcluster_nums, num_clusters<span class="op">=</span>num_clusters, n_init<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[32]</span><span class="ansi-green-fg">, line 45</span>
<span class="ansi-green-fg">     41</span>     <span style="color:rgb(0,135,0)">print</span>(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Final output saved to outputs/subgroups_clusteroutput.csv</span><span class="ansi-yellow-fg">"</span>)
<span class="ansi-green-fg">     43</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> df  <span style="font-style:italic;color:rgb(95,135,135)"># Return the modified DataFrame with clusters and subclusters</span>
<span class="ansi-green-fg">---&gt; </span><span class="ansi-green-fg">45</span> subgrouped_variable_df = run_subclustering(<span class="ansi-yellow-bg">supergrouped_variable_df</span>, subcluster_nums, num_clusters=num_clusters, n_init=<span class="ansi-green-fg">1</span>)

<span class="ansi-red-fg">NameError</span>: name 'supergrouped_variable_df' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="visualise-and-save-the-results" class="level2">
<h2 class="anchored" data-anchor-id="visualise-and-save-the-results">Visualise and save the results</h2>
<div id="cell-66" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Calculate percentage difference (subclusters vs cluster means) ---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>global_means <span class="op">=</span> subgrouped_variable_df[features].mean()</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>subcluster_means <span class="op">=</span> subgrouped_variable_df.groupby([<span class="st">"cluster"</span>, <span class="st">"subcluster"</span>]).mean(numeric_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># percentage difference: subcluster relative to global means</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>pct_diff_sub <span class="op">=</span> (subcluster_means<span class="op">/</span> global_means)<span class="op">*</span><span class="dv">100</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>pct_display_df_sub <span class="op">=</span> pct_diff_sub.T  </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">#replace the column MultiIndex with a single level index with "cluster-subcluster" format and swap in the cluster names from cluster_summaries</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>pct_display_df_sub.columns <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>cluster_summaries[c[<span class="dv">0</span>]][<span class="st">'name'</span>]<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>c[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c <span class="kw">in</span> pct_display_df_sub.columns]</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co"># build customdata for hover (human names repeated across cluster–subcluster combos)</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>human_names <span class="op">=</span> pct_display_df_sub.index.<span class="bu">map</span>(<span class="kw">lambda</span> e: encoding_to_name.get(e, e)).values</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>customdata_pct_sub <span class="op">=</span> np.tile(human_names.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>), (<span class="dv">1</span>, pct_display_df_sub.shape[<span class="dv">1</span>]))</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Heatmap (percentage difference: subcluster vs cluster mean) ---</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>fig_pct_sub <span class="op">=</span> px.imshow(</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    pct_display_df_sub,</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    color_continuous_scale<span class="op">=</span><span class="st">"RdYlGn"</span>,</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    origin<span class="op">=</span><span class="st">"lower"</span>,</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    aspect<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span><span class="bu">dict</span>(x<span class="op">=</span><span class="st">"Subcluster"</span>, y<span class="op">=</span><span class="st">"Feature (encoding)"</span>, color<span class="op">=</span><span class="st">"</span><span class="sc">% o</span><span class="st">f cluster mean"</span>),</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    zmin<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    zmax<span class="op">=</span><span class="dv">200</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="co"># attach customdata and set hover</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>fig_pct_sub.data[<span class="dv">0</span>].customdata <span class="op">=</span> customdata_pct_sub</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>fig_pct_sub.update_traces(</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    hovertemplate<span class="op">=</span><span class="st">"Subcluster: %</span><span class="sc">{x}</span><span class="st">&lt;br&gt;Encoding: %</span><span class="sc">{y}</span><span class="st">&lt;br&gt;Name: %</span><span class="sc">{customdata}</span><span class="st">&lt;br&gt;</span><span class="sc">% o</span><span class="st">f Cluster Mean: %</span><span class="sc">{z:.1f}</span><span class="st">%&lt;extra&gt;&lt;/extra&gt;"</span>,</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>    zmid<span class="op">=</span><span class="dv">100</span>  <span class="co"># centre colours on 100%</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>fig_pct_sub.update_layout(</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Subcluster Profiles (</span><span class="sc">% o</span><span class="st">f Cluster Mean)"</span>,</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">"Subcluster"</span>,</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">"Feature (encoding)"</span>,</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">800</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="co"># get mapping of column → cluster</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>col_clusters <span class="op">=</span> [col.split(<span class="st">"-"</span>)[<span class="dv">0</span>] <span class="cf">for</span> col <span class="kw">in</span> pct_display_df_sub.columns]</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="co"># find where cluster changes (between adjacent columns)</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>boundaries <span class="op">=</span> [</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    i <span class="op">+</span> <span class="fl">0.5</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(col_clusters) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col_clusters[i] <span class="op">!=</span> col_clusters[i <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="co"># add vertical lines at these boundaries</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b <span class="kw">in</span> boundaries:</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    fig_pct_sub.add_vline(</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>b, line_width<span class="op">=</span><span class="dv">2</span>, line_dash<span class="op">=</span><span class="st">"dash"</span>, line_color<span class="op">=</span><span class="st">"black"</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>fig_pct_sub.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[33]</span><span class="ansi-green-fg">, line 4</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)"># --- Calculate percentage difference (subclusters vs cluster means) ---</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">4</span> global_means = <span class="ansi-yellow-bg">subgrouped_variable_df</span>[features].mean()
<span class="ansi-green-fg">      5</span> subcluster_means = subgrouped_variable_df.groupby([<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">cluster</span><span class="ansi-yellow-fg">"</span>, <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">subcluster</span><span class="ansi-yellow-fg">"</span>]).mean(numeric_only=<span style="font-weight:bold;color:rgb(0,135,0)">True</span>)
<span class="ansi-green-fg">      7</span> <span style="font-style:italic;color:rgb(95,135,135)"># percentage difference: subcluster relative to global means</span>

<span class="ansi-red-fg">NameError</span>: name 'subgrouped_variable_df' is not defined</pre>
</div>
</div>
</div>
<p>Save the results to file for use in GIS software or to format for sharing:</p>
<div id="cell-68" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#merge the geometry column from oas_region to subgrouped_variable_df to make a geodataframe</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> oas_region.merge(subgrouped_variable_df  , left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">#save to file</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>gdf.to_file(<span class="st">"outputs/subclusters_geodataframe.gpkg"</span>, layer<span class="op">=</span><span class="st">'subclusters'</span>, driver<span class="op">=</span><span class="st">"GPKG"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[34]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> <span style="font-style:italic;color:rgb(95,135,135)">#merge the geometry column from oas_region to subgrouped_variable_df to make a geodataframe</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> gdf = <span class="ansi-yellow-bg">oas_region</span>.merge(subgrouped_variable_df  , left_index=<span style="font-weight:bold;color:rgb(0,135,0)">True</span>, right_index=<span style="font-weight:bold;color:rgb(0,135,0)">True</span>, how=<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">left</span><span class="ansi-yellow-fg">'</span>)
<span class="ansi-green-fg">      3</span> <span style="font-style:italic;color:rgb(95,135,135)">#save to file</span>
<span class="ansi-green-fg">      4</span> gdf.to_file(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">outputs/subclusters_geodataframe.gpkg</span><span class="ansi-yellow-fg">"</span>, layer=<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">subclusters</span><span class="ansi-yellow-fg">'</span>, driver=<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">GPKG</span><span class="ansi-yellow-fg">"</span>)

<span class="ansi-red-fg">NameError</span>: name 'oas_region' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="map-the-subclusters" class="level2">
<h2 class="anchored" data-anchor-id="map-the-subclusters">Map the Subclusters</h2>
<iframe src="outputs/maps/subcluster_map.html" width="100%" height="650" style="border:none;">
</iframe>



</section>
</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>